<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>ç±½å¥¥ä¸­å­¦ç½‘ç»œå®‰å…¨å†’é™© Â· ç¬¬ 2 ç« </title>
  <style>
    :root {
      color-scheme: dark;
      --bg-dark: #020817;
      --card-bg: rgba(10, 16, 32, 0.8);
      --accent: #64b5f6;
      --accent-soft: rgba(100, 181, 246, 0.2);
      --danger: #ef5350;
      --success: #81c784;
      --text-main: #e3f2fd;
      --text-soft: #b0bec5;
      --border-subtle: rgba(148, 163, 184, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui,
        -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0b1020, #000000);
      color: var(--text-main);
      overflow: hidden;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .hidden {
      display: none !important;
    }

    /* èƒŒæ™¯å›¾ */

    #game-root {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .game-bg {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      filter: blur(3px) brightness(0.8);
      opacity: 0.95;
      z-index: 0;
      transition: background-image 0.2s ease-out;
    }

    .game-wrapper {
      position: relative;
      z-index: 1;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .game-card {
      position: relative;
      width: 900px;
      max-width: 100%;
      height: 560px;
      max-height: 100%;
      background: radial-gradient(circle at top, #050816, #020617);
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
      overflow: hidden;
    }

    /* å¼€å§‹é¡µ */

    .start-screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: radial-gradient(circle at top, rgba(20, 31, 57, 0.92), #020617);
      text-align: center;
    }

    .start-title {
      font-size: 24px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin-bottom: 6px;
      color: var(--accent);
    }

    .start-subtitle {
      font-size: 18px;
      margin-bottom: 12px;
    }

    .start-desc {
      max-width: 520px;
      font-size: 14px;
      color: var(--text-soft);
      line-height: 1.5;
      margin: 0 auto 20px auto;
    }

    .start-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 260px;
      max-width: 100%;
    }

    .start-button {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(135deg, #0ea5e9, #6366f1);
      color: white;
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.5);
      transition: transform 0.12s ease, box-shadow 0.12s ease,
        background 0.12s ease;
    }

    .start-button.secondary {
      background: rgba(30, 64, 175, 0.2);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.8);
    }

    .start-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 32px rgba(59, 130, 246, 0.7);
    }

    .start-hint {
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-soft);
    }

    /* ä¸» UI */

    .game-ui {
      position: absolute;
      inset: 0;
      padding: 16px 18px 14px;
      display: flex;
      flex-direction: column;
      background: linear-gradient(
        to bottom,
        rgba(7, 12, 24, 0.4),
        rgba(7, 12, 24, 0.75)
      );
    }

    .scene-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
      position: relative;
    }

    .scene-text {
      flex: 1;
      min-height: 0;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 14px;
      line-height: 1.6;
      overflow-y: auto;
      scrollbar-width: thin;
    }

    .scene-text p {
      margin: 4px 0;
    }

    .scene-text .highlight {
      color: var(--accent);
      font-weight: 600;
    }

    .scene-text .npc {
      margin-top: 6px;
      font-weight: 600;
      color: #facc15;
    }

    .scene-text .aside {
      color: var(--text-soft);
      font-size: 13px;
    }

    .choice-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    /* ç»“å±€ç»“ç®—é¢æ¿ */
    .settlement-panel {
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 12px;
      background: radial-gradient(circle at top, rgba(34, 197, 94, 0.16), rgba(15, 23, 42, 0.9));
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.85);
      display: grid;
      grid-template-columns: 1fr 180px;
      gap: 10px;
      align-items: center;
    }

    .settlement-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .settlement-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      width: fit-content;
    }

    .settlement-badge-good {
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.9);
      background: radial-gradient(circle at top, rgba(22, 163, 74, 0.2), rgba(6, 78, 59, 0.7));
      box-shadow: 0 0 18px rgba(34, 197, 94, 0.45);
    }

    .settlement-badge-bad {
      color: #fecdd3;
      border: 1px solid rgba(248, 113, 113, 0.95);
      background: radial-gradient(circle at top, rgba(239, 68, 68, 0.2), rgba(127, 29, 29, 0.7));
      box-shadow: 0 0 18px rgba(248, 113, 113, 0.45);
    }

    .settlement-title {
      font-size: 17px;
      font-weight: 700;
      color: #e0f2fe;
    }

    .settlement-desc {
      font-size: 13px;
      color: var(--text-soft);
      line-height: 1.5;
    }

    .settlement-stats {
      list-style: none;
      margin: 0;
      padding: 0;
      font-size: 12px;
      color: #cbd5e1;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .settlement-right {
      justify-self: end;
      text-align: right;
      font-size: 12px;
      color: var(--text-soft);
      line-height: 1.4;
    }

    .settlement-score {
      font-size: 22px;
      font-weight: 800;
      color: var(--accent);
      text-shadow: 0 0 12px rgba(59, 130, 246, 0.5);
    }

    /* å¯¹è¯æ—¶çš„ NPC å¤´åƒå¡ç‰‡ */
    .npc-dialog-card {
      position: absolute;
      top: 6px;
      right: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.9);
      pointer-events: none;
      z-index: 2;
    }

    .npc-dialog-avatar {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: radial-gradient(circle at top, #1f2937, #020617);
      background-size: cover;
      background-position: center bottom;
      border: 2px solid rgba(191, 219, 254, 0.95);
      box-shadow: 0 0 18px rgba(59, 130, 246, 0.6);
      flex-shrink: 0;
    }

    .npc-dialog-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .npc-dialog-label {
      font-size: 10px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: #bfdbfe;
      opacity: 0.8;
    }

    .npc-dialog-name {
      font-size: 15px;
      font-weight: 700;
      color: #e0f2fe;
      line-height: 1.1;
    }

    .npc-dialog-role {
      font-size: 11px;
      color: #cbd5e1;
    }

    .choice-button {
      width: 100%;
      text-align: left;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: radial-gradient(circle at top, rgba(30, 64, 175, 0.36), #020617);
      color: var(--text-main);
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.18s ease, transform 0.18s ease,
        box-shadow 0.16s ease, border-color 0.16s ease,
        background 0.16s ease;
    }

    .choice-button.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .choice-button:hover {
      box-shadow: 0 10px 26px rgba(59, 130, 246, 0.65);
      border-color: rgba(129, 230, 217, 0.9);
      background: radial-gradient(
        circle at top,
        rgba(34, 211, 238, 0.5),
        #020617
      );
    }

    .choice-button .label {
      flex: 1;
    }

    .choice-button .hint {
      font-size: 11px;
      color: var(--text-soft);
      white-space: nowrap;
    }

    .tip-bar {
      margin-top: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px dashed rgba(148, 163, 184, 0.5);
      font-size: 11px;
      color: var(--text-soft);
    }

    /* é¡¶éƒ¨ / åº•éƒ¨å°æŒ‰é’® */

    .ui-toggle {
      position: absolute;
      left: 10px;
      top: 10px;
      z-index: 5;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
    }

    .achievements-toggle {
      position: absolute;
      right: 10px;
      bottom: 10px;
      z-index: 5;
      border-radius: 999px;
      border: 1px solid rgba(147, 197, 253, 0.9);
      background: radial-gradient(
        circle at top,
        rgba(59, 130, 246, 0.7),
        #020617
      );
      color: #e0f2fe;
      font-size: 11px;
      padding: 6px 14px;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.8);
    }

    .achievements-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 34px rgba(37, 99, 235, 0.95);
    }

    /* çŠ¶æ€ / æˆå°±é¢æ¿ */

    .ui-meta {
      position: absolute;
      left: 10px;
      top: 36px;
      width: 260px;
      max-width: 50%;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 8px 10px;
      font-size: 12px;
      color: var(--text-soft);
      backdrop-filter: blur(12px);
    }

    .status-row {
      margin: 2px 0;
    }

    .status-label {
      opacity: 0.8;
    }

    .status-value {
      color: var(--accent);
      font-weight: 500;
    }

    .progress-outer {
      position: relative;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.65);
      overflow: hidden;
      margin-top: 2px;
    }

    .progress-inner {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #eab308);
      transition: width 0.2s ease;
    }

    .achievements-panel {
      position: absolute;
      right: 10px;
      bottom: 40px;
      width: 260px;
      max-width: 70%;
      max-height: 60%;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(147, 197, 253, 0.9);
      padding: 8px 10px;
      font-size: 12px;
      color: var(--text-soft);
      overflow: auto;
      backdrop-filter: blur(12px);
    }

    .achievements-panel h3 {
      margin: 2px 0 4px 0;
      font-size: 13px;
      color: var(--accent);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .achievements-panel ul {
      list-style: none;
      padding: 0;
      margin: 4px 0;
    }

    .achievements-panel li {
      padding: 4px 0;
      border-bottom: 1px dashed rgba(71, 85, 105, 0.7);
    }

    .achievements-panel li:last-child {
      border-bottom: none;
    }

    .ach-name-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .ach-name-zh {
      color: #e5e7eb;
    }

    .ach-name-en {
      color: #9ca3af;
      font-size: 11px;
    }

        .ach-badge {
      font-size: 11px;
      padding: 1px 6px;
      border-radius: 999px;
      align-self: flex-start;
      white-space: nowrap;
    }

    /* å·²è§£é”ï¼šç»¿è‰² */
    .ach-badge-unlocked {
      border: 1px solid rgba(34, 197, 94, 0.85);
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.22);
    }

    /* æœªè§£é”ï¼šçº¢è‰² */
    .ach-badge-locked {
      border: 1px solid rgba(248, 113, 113, 0.9);
      color: #fecaca;
      background: rgba(127, 29, 29, 0.6);
    }


    .ach-desc-small {
      margin-top: 1px;
      font-size: 11px;
      color: var(--text-soft);
    }

    /* æˆå°±å¼¹å‡ºæµ®å±‚ */

    .achievement-float {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 0.25s ease, transform 0.25s ease;
      z-index: 10;
    }

        /* NPC å‡ºåœºä»‹ç»æµ®å±‚ */
    /* NPC ç«‹ç»˜å‡ºåœºæµ®å±‚ */
.npc-intro-overlay {
  position: absolute;
  inset: 0;
  z-index: 12;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(2,6,23,0.96));
  backdrop-filter: blur(14px);
  opacity: 0;
  transform: translateY(14px) scale(0.94);
  pointer-events: none;
  transition: opacity 0.22s ease, transform 0.22s ease;
}

.npc-intro-overlay.npc-intro-show {
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: auto;
}

.npc-intro-overlay.npc-intro-hide {
  opacity: 0;
  transform: translateY(18px) scale(0.9);
  pointer-events: none;
}

.npc-intro-card {
  width: min(720px, 94%);
  margin-bottom: 8vh;
  padding: 16px 18px 12px;
  border-radius: 22px;
  background:
    radial-gradient(circle at top left, rgba(56,189,248,0.28), transparent 60%),
    radial-gradient(circle at top right, rgba(129,140,248,0.32), transparent 60%),
    linear-gradient(135deg, rgba(15,23,42,0.95), rgba(15,23,42,0.98));
  border: 1px solid rgba(191,219,254,0.95);
  box-shadow: 0 28px 70px rgba(15,23,42,0.98);
  display: grid;
  grid-template-columns: minmax(130px, 220px) 1fr;
  grid-template-rows: auto auto;
  gap: 10px 16px;
  align-items: flex-end;
  position: relative;
  overflow: hidden;
}

/* èƒŒæ™¯å…‰æ™• */
.npc-intro-card::before {
  content: "";
  position: absolute;
  inset: 10% 30% auto;
  height: 180px;
  background: radial-gradient(circle at center, rgba(96,165,250,0.6), transparent 70%);
  opacity: 0.55;
  pointer-events: none;
}

/* ç«‹ç»˜ */
.npc-intro-avatar {
  width: 100%;
  max-width: 220px;
  height: 260px;
  border-radius: 20px;
  background: radial-gradient(circle at top, #1f2937, #020617);
  background-size: cover;
  background-position: center bottom;
  border: 2px solid rgba(191,219,254,0.95);
  box-shadow:
    0 12px 26px rgba(15,23,42,0.95),
    0 0 30px rgba(129,140,248,0.9);
  transform-origin: bottom center;
  animation: npcSpriteFloat 3s ease-in-out infinite;
  grid-row: 1 / span 2;
}

/* ç«‹ç»˜è½»å¾®ä¸Šä¸‹æµ®åŠ¨ */
@keyframes npcSpriteFloat {
  0%   { transform: translateY(0) scale(1); }
  50%  { transform: translateY(-6px) scale(1.01); }
  100% { transform: translateY(0) scale(1); }
}

/* æ–‡æœ¬åŒºåŸŸ */
.npc-intro-text {
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  gap: 2px;
  position: relative;
  z-index: 1;
}

/* ä¸Šé¢çš„â€œå°æ ‡é¢˜ + åå­—ç‰Œâ€æ•´ä½“ */
.npc-intro-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.18em;
  color: #bfdbfe;
  opacity: 0.9;
  margin-bottom: 4px;
}

.npc-intro-name {
  font-size: 20px;
  font-weight: 700;
  color: #e0f2fe;
  text-shadow: 0 0 14px rgba(30,64,175,0.9);
  margin-bottom: 2px;
}

.npc-intro-role {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: #bbf7d0;
  padding: 3px 10px;
  border-radius: 999px;
  background: rgba(15,23,42,0.9);
  border: 1px solid rgba(52,211,153,0.9);
  margin-bottom: 4px;
}

.npc-intro-role::before {
  content: "â—";
  font-size: 8px;
  color: #34d399;
}

/* æè¿°æ–‡æœ¬ */
.npc-intro-desc {
  font-size: 13px;
  color: #e5e7eb;
  line-height: 1.55;
  max-width: 380px;
}

/* æŒ‰é’® */
.npc-intro-btn {
  grid-column: 1 / span 2;
  justify-self: flex-end;
  border-radius: 999px;
  border: 1px solid rgba(191,219,254,0.95);
  background: radial-gradient(circle at top, #0ea5e9, #6366f1);
  color: #e0f2fe;
  font-size: 13px;
  padding: 6px 18px;
  cursor: pointer;
  box-shadow: 0 14px 32px rgba(37,99,235,0.9);
  margin-top: 4px;
  transition: transform 0.12s ease, box-shadow 0.12s ease;
}

.npc-intro-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 18px 40px rgba(37,99,235,1);
}

/* æ‰‹æœºç«¯ */
@media (max-width: 600px) {
  .npc-intro-card {
    width: 96%;
    margin-bottom: 6vh;
    padding: 12px 12px 10px;
    grid-template-columns: minmax(90px, 120px) 1fr;
    gap: 8px 10px;
  }

  .npc-intro-avatar {
    max-width: 120px;
    height: 220px;
    border-radius: 18px;
  }

  .npc-intro-name {
    font-size: 17px;
  }

  .npc-intro-desc {
    font-size: 12px;
  }

  .npc-intro-btn {
    padding: 6px 14px;
    font-size: 12px;
  }
}


    .achievement-float.active {
      opacity: 1;
      transform: scale(1);
    }

    .achievement-float.shrink {
      opacity: 0;
      transform: translate3d(140px, 180px, 0) scale(0.3);
    }

    .achievement-card-float {
      max-width: 320px;
      padding: 10px 12px;
      border-radius: 14px;
      background: radial-gradient(
        circle at top,
        rgba(29, 78, 216, 0.95),
        rgba(15, 23, 42, 0.98)
      );
      border: 1px solid rgba(191, 219, 254, 0.95);
      box-shadow: 0 22px 50px rgba(37, 99, 235, 0.9);
    }

    .ach-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.13em;
      opacity: 0.9;
      color: #bfdbfe;
      margin-bottom: 4px;
    }

    .ach-name-big {
      font-size: 15px;
      font-weight: 600;
      color: #e0f2fe;
      margin-bottom: 2px;
    }

    .ach-name-en {
      font-size: 11px;
      color: #cbd5f5;
      margin-bottom: 4px;
    }

    .ach-desc {
      font-size: 11px;
      color: #e5e7eb;
    }

    /* æ‰‹æœºç«¯é€‚é… */

    @media (max-width: 600px) {
      .game-wrapper {
        padding: 8px 0;
      }

      .game-card {
        width: 100%;
        max-width: 100%;
        height: 100%;
        max-height: 100%;
        border-radius: 0;
        box-shadow: none;
        border-left: none;
        border-right: none;
      }

      .game-ui {
        padding: 12px 10px 12px;
        background: linear-gradient(
          to bottom,
          rgba(7, 12, 24, 0.35),
          rgba(7, 12, 24, 0.7)
        );
      }

      .scene-text {
        font-size: 15px;
      }

      .choice-button {
        font-size: 14px;
        padding: 9px 11px;
      }

      .ui-toggle {
        left: 8px;
        top: 8px;
        padding: 3px 8px;
        font-size: 11px;
      }

      .achievements-toggle {
        right: 8px;
        bottom: 8px;
        padding: 5px 11px;
        font-size: 11px;
      }

      .ui-meta {
        left: 8px;
        top: 32px;
        width: 240px;
      }

      .achievements-panel {
        right: 8px;
        bottom: 36px;
        width: 240px;
      }

      .start-screen {
        padding: 16px 14px;
      }

      .start-title {
        font-size: 20px;
      }

      .start-subtitle {
        font-size: 16px;
      }

      .start-desc {
        font-size: 13px;
      }

      .start-buttons {
        width: 100%;
      }
    }
    /* ç»“å±€æ ‡é¢˜ç‰¹æ•ˆ */
.ending-banner {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
  padding: 6px 14px;
  border-radius: 999px;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  font-size: 12px;
  position: relative;
  overflow: hidden;
  isolation: isolate;
  animation: endingPulse 1.8s ease-in-out infinite alternate;
}

.ending-banner span {
  position: relative;
  z-index: 1;
}

/* æµå…‰æ•ˆæœ */
.ending-banner::before {
  content: "";
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at top left, rgba(255,255,255,0.16), transparent 65%);
  opacity: 0;
  transform: translateX(-40%);
  transition: opacity .4s ease, transform .4s ease;
}

.ending-banner:hover::before {
  opacity: 1;
  transform: translateX(0);
}

/* å¥½ç»“å±€ */
.ending-good {
  color: #bbf7d0;
  border: 1px solid rgba(34,197,94,0.9);
  background: radial-gradient(circle at top, rgba(22,163,74,0.28), rgba(6,78,59,0.94));
  box-shadow: 0 0 24px rgba(34,197,94,0.7);
}

/* åç»“å±€ */
.ending-bad {
  color: #fee2e2;
  border: 1px solid rgba(248,113,113,0.95);
  background: radial-gradient(circle at top, rgba(239,68,68,0.3), rgba(127,29,29,0.96));
  box-shadow: 0 0 24px rgba(248,113,113,0.85);
}

/* å·¦ä¾§å°æ ‡ç­¾ï¼Œæ¯”å¦‚ GOOD / BAD */
.ending-label {
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 10px;
  background: rgba(15,23,42,0.85);
}

/* è®©æ•´ä¸ªæ¡ç¨å¾®ä¸Šä¸‹å‘¼å¸ä¸€ä¸‹ */
@keyframes endingPulse {
  from {
    transform: translateY(0) scale(1);
    opacity: 0.96;
  }
  to {
    transform: translateY(-2px) scale(1.02);
    opacity: 1;
  }
}

  </style>
</head>
<body>
<div id="game-root">
  <div id="game-bg" class="game-bg"></div>

  <div class="game-wrapper">
    <div class="game-card">
      <!-- å¼€å§‹é¡µ -->
      <div id="start-screen" class="start-screen">
        <div class="start-title">ç±½å¥¥ä¸­å­¦ Â· Cyber Adventure</div>
        <div class="start-subtitle">ç¬¬ 2 ç«  Â· å®¿èˆé‡Œçš„é™Œç”Ÿ Wi-Fi</div>
        <p class="start-desc">
          æœºæˆ¿çš„å‹’ç´¢è½¯ä»¶é£æ³¢æš‚æ—¶å‘Šä¸€æ®µè½ã€‚ä½†çœŸæ­£çš„æ”»é˜²ï¼Œå¾€å¾€å‘ç”Ÿåœ¨ä½ ä»¥ä¸ºâ€œåªæ˜¯åˆ·åˆ·æ‰‹æœºâ€çš„æ—¶å€™ã€‚<br />
          è¿™ä¸€æ¬¡ï¼Œæ•…äº‹ä»å®¿èˆæ¥¼ä¸‹çš„ä¸€å¼  A4 é€šçŸ¥å’Œä¸€ä¸ªé™Œç”Ÿçš„ Wi-Fi åå­—å¼€å§‹â€¦â€¦
        </p>
        <div class="start-buttons">
          <button id="btn-start-load" class="start-button">
            ä»ç¬¬ 1 ç« å­˜æ¡£å¼€å§‹
          </button>
          <button id="btn-start-fresh" class="start-button secondary">
            ç›´æ¥ä»¥é»˜è®¤èº«ä»½å¼€å§‹ç¬¬ 2 ç« 
          </button>
        </div>
        <div class="start-hint">
          å»ºè®®å…ˆä»ç¬¬ 1 ç« çš„ <code>index.html</code> ç»“å°¾è¿›å…¥æœ¬ç« ï¼›<br />
          å¦‚æœæ²¡æœ‰å­˜æ¡£ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½“éªŒç¬¬äºŒç« ã€‚
        </div>
      </div>

      <!-- ä¸»ç•Œé¢ -->
      <div id="game-ui" class="game-ui hidden">
        <button id="meta-toggle" class="ui-toggle">çŠ¶æ€ / ä¿¡æ¯</button>
        <button id="achievements-toggle" class="achievements-toggle">
          æˆå°± Achievements
        </button>

        <div id="ui-meta" class="ui-meta hidden">
          <div class="status-row">
            <span class="status-label">èº«ä»½ï¼š</span>
            <span class="status-value" id="status-role">(é»˜è®¤ï¼šå­¦ç”Ÿ)</span>
          </div>
          <div class="status-row">
            <span class="status-label">ä¿¡ä»» æ®·è€å¸ˆï¼š</span>
            <span class="status-value" id="status-trust-yin">0</span>
          </div>
          <div class="status-row">
            <span class="status-label">ä¿¡ä»» é‡‘è€å¸ˆï¼š</span>
            <span class="status-value" id="status-trust-jin">0</span>
          </div>
          <div class="status-row" style="margin-top:4px;">
            <div class="status-label">ç¬¬äºŒç« è¿›åº¦ï¼š</div>
            <div class="progress-outer">
              <div id="status-progress-bar" class="progress-inner"></div>
            </div>
          </div>
        </div>

        <div id="achievements-panel" class="achievements-panel hidden">
          <h3>
            çŸ¥è¯†æˆå°±
            <span
              style="
                font-size: 11px;
                font-weight: 400;
                color: var(--text-soft);
              "
            >
              ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®å¯å†æ¬¡æ‰“å¼€
            </span>
          </h3>
          <ul id="achievements-list"></ul>
        </div>

        <div class="scene-area">
          <div id="npc-dialog-card" class="npc-dialog-card hidden">
            <div id="npc-dialog-avatar" class="npc-dialog-avatar"></div>
            <div class="npc-dialog-info">
              <div class="npc-dialog-label">å½“å‰å¯¹è¯</div>
              <div id="npc-dialog-name" class="npc-dialog-name"></div>
              <div id="npc-dialog-role" class="npc-dialog-role"></div>
            </div>
          </div>
          <div id="scene-text" class="scene-text"></div>
          <div id="choice-list" class="choice-list"></div>
          <div id="settlement-panel" class="settlement-panel hidden">
            <div class="settlement-left">
              <div id="settlement-badge" class="settlement-badge">ç»“å±€</div>
              <div id="settlement-title" class="settlement-title">ç»“å±€æ ‡é¢˜</div>
              <div id="settlement-desc" class="settlement-desc">
                è¿™æ˜¯ç»“å±€è¡¥å……æè¿°ã€‚
              </div>
              <ul id="settlement-stats" class="settlement-stats"></ul>
            </div>
            <div class="settlement-right">
              <div>ç¬¬äºŒç« å®‰å…¨è¯„åˆ†</div>
              <div id="settlement-score" class="settlement-score">0</div>
              <div id="settlement-score-hint">å¤šæ³¨æ„ç½‘ç»œé’“é±¼ä¸å‡çƒ­ç‚¹</div>
            </div>
          </div>
        </div>

        <div id="tip-bar" class="tip-bar">
          æ¬¢è¿æ¥åˆ°ç¬¬äºŒç« ã€‚æ³¨æ„è§‚å¯Ÿ Wi-Fi åå­—ã€ç½‘å€å°é”å’Œå„ç§â€œå¥½å¾—è¿‡å¤´â€çš„ç¦åˆ©æç¤ºã€‚
        </div>
      </div>

      <!-- æˆå°±å¼¹å‡ºæµ®å±‚ -->
      <div id="achievement-float" class="achievement-float hidden">
        <div id="achievement-float-inner" class="achievement-card-float">
          <!-- åŠ¨æ€å¡«å…… -->
        </div>
      </div>
            <!-- NPC å‡ºåœºä»‹ç»æµ®å±‚ -->
    <!-- NPC å‡ºåœºä»‹ç»æµ®å±‚ -->
<div id="npc-intro-overlay" class="npc-intro-overlay hidden">
  <div class="npc-intro-card">
    <div class="npc-intro-avatar" id="npc-intro-avatar"></div>
    <div class="npc-intro-text">
      <div class="npc-intro-label">è§’è‰²ç™»åœº Â· New character</div>
      <div class="npc-intro-name" id="npc-intro-name"></div>
      <div class="npc-intro-role" id="npc-intro-role"></div>
      <div class="npc-intro-desc" id="npc-intro-desc"></div>
    </div>
    <button class="npc-intro-btn" id="npc-intro-btn">ç»§ç»­</button>
  </div>
</div>

    </div>
  </div>
</div>

<!-- èƒŒæ™¯éŸ³ä¹ä¸éŸ³æ•ˆï¼ˆä½ å¯ä»¥æ¢æˆè‡ªå·±çš„ç´ æï¼‰ -->
<audio id="bgm_calm" src="audio/bgm_calm.mp3" preload="auto" loop></audio>
<audio id="bgm_tension" src="audio/bgm_tension.mp3" preload="auto" loop></audio>
<audio id="bgm_office" src="audio/bgm_office.mp3" preload="auto" loop></audio>

<audio id="sfx_choice" src="audio/sfx_choice_click.mp3" preload="auto"></audio>
<audio
  id="sfx_achievement"
  src="audio/sfx_achievement_fanfare.mp3"
  preload="auto"
></audio>
<audio
  id="sfx_typewriter"
  src="audio/sfx_typewriter_soft.mp3"
  preload="auto"
></audio>

<script>
  // ========= å…¨å±€çŠ¶æ€ =========

  let state = {
  role: null,
  trustYin: 0,
  trustJin: 0,
  progress: 0,
  knowledge: new Set(),
  // ç¬¬äºŒç« æœ¬åœ°è®°å½•ï¼šå“ªäº› NPC å·²ç»å‡ºåœºä»‹ç»è¿‡
  seenNpcs: new Set()
};

  // ä» index.html çš„ç¬¬ä¸€ç« å­˜æ¡£åŠ è½½
  function loadGameFromLocal() {
    try {
      const raw = localStorage.getItem("zaoCyberGameSave");
      if (!raw) {
        console.log("æ²¡æœ‰æ‰¾åˆ°æœ¬åœ°å­˜æ¡£ï¼Œç¬¬äºŒç« å°†ä»¥é»˜è®¤çŠ¶æ€å¼€å§‹ã€‚");
        return;
      }
      const data = JSON.parse(raw);
      if (!data || typeof data !== "object") return;
      console.log("è¯»å–åˆ°æœ¬åœ°å­˜æ¡£ï¼š", data);

      state.role = data.role || state.role;
      state.trustYin =
        data.trustYin !== undefined ? data.trustYin : state.trustYin;
      state.trustJin =
        data.trustJin !== undefined ? data.trustJin : state.trustJin;
      state.progress =
        data.progress !== undefined ? data.progress : state.progress;
      if (Array.isArray(data.knowledge)) {
        state.knowledge = new Set(data.knowledge);
      }
    } catch (e) {
      console.warn("è¯»å–æœ¬åœ°å­˜æ¡£å¤±è´¥ï¼š", e);
    }
  }

  // ========= éŸ³é¢‘ï¼ˆBGM + SFXï¼‰ =========
  let currentBgmAudio = null;

  function playBgm(kind) {
    const map = {
      calm: "bgm_calm",
      tension: "bgm_tension",
      office: "bgm_office"
    };
    const id = map[kind] || "bgm_calm";
    const el = document.getElementById(id);
    if (!el) return;
    if (currentBgmAudio === el) return;
    try {
      if (currentBgmAudio) {
        currentBgmAudio.pause();
      }
      currentBgmAudio = el;
      el.loop = true;
      if (el.paused) {
        el.currentTime = 0;
        el.play().catch(() => {});
      }
    } catch (e) {
      console.warn("æ’­æ”¾ BGM å‡ºé”™ï¼š", e);
    }
  }

  function ensureBgmResumes() {
    if (currentBgmAudio && currentBgmAudio.paused) {
      currentBgmAudio.play().catch(() => {});
    }
  }

  function playSfx(name) {
    let id = null;
    if (name === "choice") id = "sfx_choice";
    else if (name === "achievement") id = "sfx_achievement";
    else if (name === "typewriter") id = "sfx_typewriter";
    if (!id) return;
    const el = document.getElementById(id);
    if (!el) return;
    try {
      el.currentTime = 0;
      el.play().catch(() => {});
    } catch (e) {
      console.warn("æ’­æ”¾éŸ³æ•ˆå‡ºé”™ï¼š", e);
    }
  }

  // æ‰“å­—æœºéŸ³æ•ˆï¼šæ•´æ®µå¾ªç¯æ’­æ”¾ï¼Œåˆ°æ–‡å­—æ‰“å®Œä¸ºæ­¢
  const sfxTypeEl = document.getElementById("sfx_typewriter");
  let typingSoundKey = null;

  function startTypingSound(ownerKey) {
    if (!sfxTypeEl) return;
    if (typingSoundKey === ownerKey) return;
    typingSoundKey = ownerKey;
    try {
      sfxTypeEl.loop = true;
      sfxTypeEl.currentTime = 0;
      sfxTypeEl.play().catch(() => {});
    } catch (e) {}
  }

  function stopTypingSound(ownerKey) {
    if (!sfxTypeEl) return;
    if (ownerKey && ownerKey !== typingSoundKey) return;
    typingSoundKey = null;
    try {
      sfxTypeEl.pause();
      sfxTypeEl.loop = false;
      sfxTypeEl.currentTime = 0;
    } catch (e) {}
    ensureBgmResumes();
  }

  // ========= èƒŒæ™¯å›¾ =========
  function setBackgroundImage(url) {
    const bgEl = document.getElementById("game-bg");
    if (!bgEl) return;
    if (!url) {
      bgEl.style.backgroundImage =
        "radial-gradient(circle at top, #263238, #000000)";
      return;
    }
    const img = new Image();
    img.onload = () => {
      console.log("èƒŒæ™¯å›¾åŠ è½½æˆåŠŸ:", url);
      bgEl.style.backgroundImage = `url("${url}")`;
    };
    img.onerror = () => {
      console.warn("èƒŒæ™¯å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥è·¯å¾„/æ–‡ä»¶åï¼š", url);
      bgEl.style.backgroundImage =
        "radial-gradient(circle at top, #37474f, #000000)";
    };
    img.src = url;
  }

  // ========= çŸ¥è¯†ç‚¹ & æˆå°± =========
  const knowledgeData = {
    rogue_wifi: {
      zh: "æ¶æ„ Wi-Fi çƒ­ç‚¹ / ä¼ªè£…æ¥å…¥ç‚¹",
      en: "Rogue Wi-Fi hotspot (evil twin AP)",
      desc:
        "ä¸æ˜æ¥æºæˆ–å‡å†’åç§°çš„æ— çº¿çƒ­ç‚¹å¯èƒ½æˆªè·ä½ çš„æ˜æ–‡æµé‡ï¼Œç”šè‡³ä¼ªé€ ç™»å½•é¡µé¢çªƒå–è´¦å·å¯†ç ã€‚"
    },
    https_ssl: {
      zh: "HTTPS / SSL/TLS è¯ä¹¦ä¸â€œå°é”â€å›¾æ ‡",
      en: "HTTPS, SSL/TLS certificate & padlock",
      desc:
        "æµè§ˆå™¨åœ°å€æ çš„å°é”å’Œ https:// è¯´æ˜è¿æ¥ç»è¿‡åŠ å¯†ä¸”æœåŠ¡å™¨èº«ä»½å·²é€šè¿‡è¯ä¹¦éªŒè¯ï¼›å‡ç«™ç‚¹å¸¸å¸¸æ²¡æœ‰æˆ–ä¼ªè£…å¾—å¾ˆç²—ç³™ã€‚"
    },
    phishing_message: {
      zh: "ç½‘ç»œé’“é±¼ï¼ˆé‚®ä»¶ / çŸ­ä¿¡ / ç¾¤èŠï¼‰",
      en: "Phishing via email, SMS or chat",
      desc:
        "é€šè¿‡ä¼ªè£…æˆå®˜æ–¹é€šçŸ¥ã€å¥–å­¦é‡‘ã€å…æµ‹ç”³è¯·ç­‰ï¼Œè¯±å¯¼ä½ ç‚¹å‡»æ¶æ„é“¾æ¥æˆ–è¾“å…¥è´¦å·å¯†ç ä¸æ•æ„Ÿä¿¡æ¯ã€‚"
    },
    privacy_settings: {
      zh: "éšç§è®¾ç½®ä¸æœ€å°åŒ–å…¬å¼€ä¿¡æ¯",
      en: "Privacy settings & data minimisation",
      desc:
        "åˆç†è®¾ç½®ç¤¾äº¤è´¦å·å’Œåº”ç”¨æƒé™ï¼Œå°½é‡å°‘å…¬å¼€ä¸ªäººä¿¡æ¯ï¼Œä»¥å‡å°‘è¢«ç¤¾å·¥å’Œå®šå‘æ”»å‡»åˆ©ç”¨çš„é£é™©ã€‚"
    }
  };
    // ========= NPC èµ„æ–™ =========
  const npcProfiles = {
    "çš‡å¤ªå­ï¼ˆçŒ«ï¼‰": {
      role: "ç±½å¥¥ä¸­å­¦Â·çŒ«ä¸­ä¹‹ç‹",
      avatar: "img/npc_cat.png", // ä»¥åä½ å¯ä»¥æ¢æˆçœŸå®å›¾
      desc: "å¸¸å¹´åœ¨æ ¡å›­å·¡è§†çš„çŒ«çš‡ï¼Œå¯¹æ¯ä¸€æ¡å°è·¯å’Œæ¯ä¸€ä¸ªæš—è§’éƒ½æ¯”ä»»ä½•äººç†Ÿã€‚"
    },
    "æ»‘å¸ˆå‚…": {
      role: "ä¿å®‰ï¼ˆé—¨å«ï¼‰",
      avatar: "img/npc_guard_hua.png",
      desc: "ç™½å¤©çœ‹èµ·æ¥å¾ˆä½›ç³»ï¼Œå®é™…ä¸Šæ¯å¤©éƒ½åœ¨è§‚å¯Ÿè¿›å‡ºæ ¡å›­çš„æ¯ä¸€ä¸ªâ€œå¼‚å¸¸â€ã€‚"
    },
    "å—¨å¸ˆå‚…": {
      role: "ä¿å®‰ï¼ˆå¤œç­ï¼‰",
      avatar: "img/npc_guard_hai.png",
      desc: "å¤œç­ä¿å®‰ï¼Œæ‰“å“ˆæ¬ çš„é¢‘ç‡å’Œå¯¹å¼‚å¸¸å£°éŸ³çš„æ•æ„Ÿåº¦æˆåæ¯”ã€‚"
    },
    "æ›¾é±¼å„¿": {
      role: "ç”·å®¿ç®¡ / å¤œå·¡",
      avatar: "img/npc_zen.png",
      desc: "è´Ÿè´£ç”·ç”Ÿå®¿èˆçš„å‡ºå…¥å’Œå®‰å…¨ï¼Œå¯¹â€œå¥‡æ€ªçš„ Wi-Fi åå­—â€å¼‚å¸¸æ•æ„Ÿã€‚"
    },
    "æå°å‡¤": {
      role: "ä½“è‚²è€å¸ˆ",
      avatar: "img/npc_pe_li.png",
      desc: "è´Ÿè´£ä½“è‚²é•¿è·‘ä¸ä½“æµ‹ï¼Œå¸¸è¢«éª—å­å†’å……åå­—å‘å„ç§â€œå…æµ‹é€šçŸ¥â€ã€‚"
    },
    "æ®·ç¼ºæ–¯æ±€": {
      role: "è®¡ç®—æœºç§‘å­¦è€å¸ˆ",
      avatar: "img/npc_yin.png",
      desc: "ä¼ è¯´ä¸­çš„â€œæ®·è€å¸ˆâ€ï¼Œæ“…é•¿æ²™ç®±åˆ†æå’Œæº¯æºï¼Œæ€»èƒ½ä»æ—¥å¿—é‡Œç¿»å‡ºæ”»å‡»è€…çš„è„šå°ã€‚"
    },
    "é‡‘åèŠ±è€å¸ˆ": {
      role: "IT éƒ¨é—¨ / è¿ç»´",
      avatar: "img/npc_jin.png",
      desc: "å¹•åè¿ç»´å¤§ç¥ï¼Œå’Œé˜²ç«å¢™ã€äº¤æ¢æœºèŠå¤©çš„æ—¶é—´æ¯”å’ŒäººèŠå¤©å¤šã€‚"
    }
  };

  let npcIntroQueue = [];
  let npcIntroPlaying = false;

  // æ˜¾ç¤º NPC å‡ºåœºå¤§å¡ç‰‡
  function showNpcIntro(name) {
    const npc = npcProfiles[name];
    if (!npc) return;
    const overlay = document.getElementById("npc-intro-overlay");
    const avatarEl = document.getElementById("npc-intro-avatar");
    const nameEl = document.getElementById("npc-intro-name");
    const roleEl = document.getElementById("npc-intro-role");
    const descEl = document.getElementById("npc-intro-desc");
    const btnEl = document.getElementById("npc-intro-btn");

    if (!overlay || !avatarEl || !nameEl || !roleEl || !descEl || !btnEl) return;

    // å¤´åƒèƒŒæ™¯å›¾ï¼ˆå¦‚æœ404ä¼šé€€å›é»˜è®¤åº•è‰²ï¼‰
    avatarEl.style.backgroundImage = npc.avatar
      ? `url("${npc.avatar}")`
      : "none";

    nameEl.textContent = name;
    roleEl.textContent = npc.role || "";
    descEl.textContent = npc.desc || "";

    overlay.classList.remove("hidden", "npc-intro-hide");
    // é‡æ–°è§¦å‘åŠ¨ç”»
    void overlay.offsetWidth;
    overlay.classList.add("npc-intro-show");
    playSfx("achievement");

    btnEl.onclick = () => {
      overlay.classList.remove("npc-intro-show");
      overlay.classList.add("npc-intro-hide");
      setTimeout(() => {
        overlay.classList.add("hidden");
        npcIntroPlaying = false;
        processNpcIntroQueue();
      }, 220);
    };
  }

  function processNpcIntroQueue() {
    if (npcIntroPlaying) return;
    const next = npcIntroQueue.shift();
    if (!next) return;
    npcIntroPlaying = true;
    showNpcIntro(next);
  }

  // åœ¨åœºæ™¯æ¸²æŸ“æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ NPC éœ€è¦å‡ºåœºä»‹ç»
  function handleNpcIntro(npcs) {
    if (!npcs || !npcs.length) return;
    if (!state.seenNpcs) state.seenNpcs = new Set();
    for (const name of npcs) {
      if (!state.seenNpcs.has(name)) {
        state.seenNpcs.add(name);
        npcIntroQueue.push(name);
      }
    }
    processNpcIntroQueue();
  }

  // åœºæ™¯å¯¹è¯å¤´åƒå±•ç¤º
  function hideNpcDialog() {
    if (!npcDialogCard) return;
    npcDialogCard.classList.add("hidden");
  }

  function showNpcDialogInline(name) {
    if (
      !npcDialogCard ||
      !npcDialogAvatar ||
      !npcDialogName ||
      !npcDialogRole
    )
      return;
    const npc = npcProfiles[name] || {};
    npcDialogName.textContent = name;
    npcDialogRole.textContent = npc.role || "";
    npcDialogAvatar.style.backgroundImage = npc.avatar
      ? `url("${npc.avatar}")`
      : "radial-gradient(circle at top, #1f2937, #020617)";
    npcDialogCard.classList.remove("hidden");
  }

  function updateNpcDialogFromHtml(html) {
    if (!npcDialogCard) return;
    const temp = document.createElement("div");
    temp.innerHTML = html || "";
    const npcEl = temp.querySelector(".npc");
    if (!npcEl) {
      hideNpcDialog();
      return;
    }
    let raw = npcEl.textContent || "";
    let name = raw.replace(/[:ï¼š].*/, "").trim();
    if (!name) {
      hideNpcDialog();
      return;
    }
    showNpcDialogInline(name);
  }


  function renderAchievementsPanel() {
    const list = document.getElementById("achievements-list");
    if (!list) return;
    list.innerHTML = "";
    const unlocked = state.knowledge || new Set();
    Object.keys(knowledgeData).forEach(key => {
      const data = knowledgeData[key];
      const li = document.createElement("li");
      const row = document.createElement("div");
      row.className = "ach-name-row";

      const left = document.createElement("div");
      const zh = document.createElement("div");
      zh.className = "ach-name-zh";
      zh.textContent = data.zh;
      const en = document.createElement("div");
      en.className = "ach-name-en";
      en.textContent = data.en;
      left.appendChild(zh);
      left.appendChild(en);

           const badge = document.createElement("div");
      if (unlocked.has(key)) {
        badge.className = "ach-badge ach-badge-unlocked";
        badge.textContent = "å·²è§£é”";
      } else {
        badge.className = "ach-badge ach-badge-locked";
        badge.textContent = "æœªè§£é”";
      }

      row.appendChild(left);
      row.appendChild(badge);

      const desc = document.createElement("div");
      desc.className = "ach-desc-small";
      desc.textContent = data.desc;

      li.appendChild(row);
      li.appendChild(desc);
      list.appendChild(li);
    });
  }

  function showAchievementToast(key) {
    const data = knowledgeData[key];
    if (!data) return;
    const float = document.getElementById("achievement-float");
    const inner = document.getElementById("achievement-float-inner");
    if (!float || !inner) return;

    inner.innerHTML =
      '<div class="ach-title">çŸ¥è¯†ç‚¹è§£é” Â· New knowledge</div>' +
      `<div class="ach-name-big">${data.zh}</div>` +
      `<div class="ach-name-en">${data.en}</div>` +
      `<div class="ach-desc">${data.desc}</div>`;

    float.classList.remove("hidden", "shrink", "active");
    // è§¦å‘ä¸€æ¬¡ reflowï¼Œç¡®ä¿åŠ¨ç”»ä»å¤´å¼€å§‹
    void float.offsetWidth;
    float.classList.add("active");
    playSfx("achievement");

    setTimeout(() => {
      float.classList.add("shrink");
    }, 1100);
    setTimeout(() => {
      float.classList.remove("active", "shrink");
      float.classList.add("hidden");
    }, 1900);
  }

  function addKnowledge(key) {
    if (!state.knowledge) state.knowledge = new Set();
    if (!state.knowledge.has(key)) {
      state.knowledge.add(key);
      renderAchievementsPanel();
      showAchievementToast(key);
    }
  }

  // ========= çŠ¶æ€æ  =========
  function updateStatusBar() {
    const roleEl = document.getElementById("status-role");
    const yinEl = document.getElementById("status-trust-yin");
    const jinEl = document.getElementById("status-trust-jin");
    const barEl = document.getElementById("status-progress-bar");
    if (roleEl) {
      roleEl.textContent = state.role || "(é»˜è®¤ï¼šå­¦ç”Ÿ)";
    }
    if (yinEl) {
      yinEl.textContent = state.trustYin ?? 0;
    }
    if (jinEl) {
      jinEl.textContent = state.trustJin ?? 0;
    }
    if (barEl) {
      const v = state.progress || 0;
      barEl.style.width = Math.max(0, Math.min(100, v)) + "%";
    }
  }

  function setProgress(v) {
    state.progress = Math.max(0, Math.min(100, v));
    updateStatusBar();
  }

  // ========= æ‰“å­—æœº & é€‰é¡¹æ‰“å­— =========
  function typeWriter(html, container, key, onComplete) {
    let i = 0;
    container.innerHTML = "";

    startTypingSound(key);

    function step() {
      if (currentSceneId + "_p" + currentPageIndex !== key) {
        stopTypingSound(key);
        return;
      }
      if (i >= html.length) {
        container.innerHTML = html;
        stopTypingSound(key);
        if (typeof onComplete === "function") onComplete();
        return;
      }
      const ch = html[i];
      if (ch === "<") {
        const j = html.indexOf(">", i);
        if (j === -1) {
          i++;
        } else {
          i = j + 1;
        }
      } else {
        i++;
      }
      container.innerHTML = html.slice(0, i);
      setTimeout(step, 18);
    }

    step();
  }

  function typeChoiceLabel(text, element, key, callback) {
    let i = 0;
    element.textContent = "";
    startTypingSound(key);

    function step() {
      if (i > text.length) {
        element.textContent = text;
        stopTypingSound(key);
        if (callback) callback();
        return;
      }
      element.textContent = text.slice(0, i);
      i++;
      setTimeout(step, 16);
    }

    step();
  }

  // ========= æ–‡æœ¬åˆ†é¡µï¼ˆæŒ‰æ®µè½ç²—ç•¥åˆ†é¡µï¼‰ =========
  function paginateSceneText(html) {
    const parts = html.split(/<\/p>/i);
    const pages = [];
    let buffer = "";
    let count = 0;
    for (let raw of parts) {
      if (!raw || !raw.trim()) continue;
      buffer += raw + "</p>";
      count++;
      if (count >= 5) {
        pages.push(buffer);
        buffer = "";
        count = 0;
      }
    }
    if (buffer.trim()) {
      pages.push(buffer);
    }
    if (!pages.length) pages.push(html);
    return pages;
  }

  // ========= åœºæ™¯å®šä¹‰ï¼ˆç¬¬äºŒç« ï¼‰ =========
  let currentSceneId = null;
  let currentPages = [];
  let currentPageIndex = 0;

  const scenes = {
    scene2_intro: {
      id: "scene2_intro",
      bg: "img/bg_campus_night.jpg",
      bgm: "calm",
      tip:
        "ç¬¬äºŒç« å›´ç»•å®¿èˆ Wi-Fiã€å‡ç™»é™†é¡µå’Œç¾¤èŠé’“é±¼å±•å¼€ã€‚è®°ä½ï¼šä»»ä½•â€œå…è´¹â€æˆ–â€œå…æµ‹â€éƒ½å€¼å¾—å¤šçœ‹ä¸€çœ¼ã€‚",
        npcs: ["çš‡å¤ªå­ï¼ˆçŒ«ï¼‰", "æ»‘å¸ˆå‚…", "å—¨å¸ˆå‚…"],
      text: function () {
        return `
<p style="font-size:17px;font-weight:600;margin-bottom:4px;">
ç¬¬ 2 ç«  Â· å®¿èˆé‡Œçš„é™Œç”Ÿ Wi-Fi
</p>
<p>ä»è¡Œæ”¿æ¥¼å‡ºæ¥æ—¶ï¼Œæ ¡å›­å·²ç»å®Œå…¨é»‘äº†ï¼Œåªå‰©ä¸‹è·¯ç¯åœ¨æ“åœºè¾¹æ’æˆä¸€æ¡å®‰é™çš„å…‰å¸¦ã€‚</p>
<p>çš‡å¤ªå­æ…¢æ‚ æ‚ åœ°è·Ÿåœ¨ä½ è„šè¾¹ï¼Œå¶å°”åœä¸‹æ¥é—»ä¸€é—»è·¯è¾¹çš„è‰ä¸›ã€‚</p>
<p>å®¿èˆæ¥¼é—¨å£ï¼Œå€¼ç­çš„<span class="highlight">æ»‘å¸ˆå‚…</span>æ­£åˆ·ç€æ‰‹æœºï¼Œå¦ä¸€ä½ä¿å®‰<span class="highlight">å—¨å¸ˆå‚…</span>åœ¨é—¨å£æ‰“ç€å“ˆæ¬ ã€‚</p>
<p class="npc">æ»‘å¸ˆå‚…ï¼š</p>
<p>â€œä»Šæ™šæ—©ç‚¹å›å»å•Šï¼Œæœ€è¿‘å­¦æ ¡ç½‘çº¿é‚£è¾¹æ€ªäº‹ä¸å°‘ï¼Œä½ åˆ«åŠå¤œè¿˜åœ¨æœºæˆ¿æ™ƒã€‚â€</p>
<p class="aside">æœºæˆ¿å‹’ç´¢è½¯ä»¶çš„äº‹æƒ…ï¼Œåœ¨ä½ è„‘å­é‡Œè½»è½»æ™ƒäº†ä¸€ä¸‹ã€‚</p>
        `;
      },
      choices: [
        {
          text: "æ‰“ä¸ªæ‹›å‘¼ï¼Œç›´æ¥å¾€å®¿èˆæ¥¼é‡Œèµ°ã€‚",
          hint: "å›åˆ°å­¦ç”Ÿå®¿èˆ",
          next: "scene2_dorm_hall",
          effect: function () {
            setProgress(35);
          }
        },
        {
          text: "é¡ºå˜´é—®ä¸€å¥ï¼šâ€œæœ€è¿‘æ˜¯ä¸æ˜¯å¤šäº†ä¸ªå…è´¹ Wi-Fiï¼Ÿâ€",
          hint: "è·å¾—ä¸€ç‚¹èƒŒæ™¯æƒ…æŠ¥",
          next: "scene2_dorm_hall",
          effect: function () {
            setProgress(40);
          }
        }
      ]
    },

    scene2_dorm_hall: {
      id: "scene2_dorm_hall",
      bg: "img/bg_dorm_corridor_night.jpg",
      bgm: "calm",
      tip:
        "å®¿ç®¡æ¡Œä¸Šçš„ A4 é€šçŸ¥ç»å¸¸è—ç€å…³é”®ä¿¡æ¯ï¼Œåˆ«æŠŠå®ƒå½“â€œèƒŒæ™¯æ¿â€å¿½ç•¥æ‰ã€‚",
         npcs: ["æ›¾é±¼å„¿"],
      text: function () {
        return `
<p>å®¿èˆæ¥¼å¤§å…é‡Œäº®ç€åæš–çš„ç¯å…‰ï¼Œç”·å®¿ç®¡<span class="highlight">æ›¾é±¼å„¿</span>æ­£å€šåœ¨å€¼ç­å°åé¢æ•´ç†ä¸€å æ‰“å°å¥½çš„é€šçŸ¥ã€‚</p>
<p>å€¼ç­å°ä¸Šç”¨ç£é“è´´ç€ä¸€å¼ å´­æ–°çš„ A4 çº¸ï¼š</p>
<p style="text-align:center;margin:4px 0;">
  <span class="highlight">â€œè¿‘æœŸå‡ºç°å‡å†’ Wi-Fi â€˜ZaoFree5Gâ€™ï¼Œè¯·å‹¿è¿æ¥ã€‚â€</span>
</p>
<p class="npc">æ›¾é±¼å„¿ï¼š</p>
<p>â€œä¸çŸ¥é“æ˜¯è°æŒ‚äº†ä¸ªå…è´¹ Wi-Fiï¼Œè¿ä¸Šå»å°±è‡ªåŠ¨å¼¹ä¸ªç™»é™†é¡µé¢ï¼Œçœ‹ç€å°±ä¸é è°±ã€‚â€</p>
<p>ä»–ç„äº†ä½ ä¸€çœ¼ï¼Œåˆè¡¥äº†ä¸€å¥ï¼š</p>
<p>â€œä½ ä»¬è¿™å±Šï¼Œåˆ«è€æƒ³ç€â€˜ç™½å«–â€™ç½‘é€Ÿï¼Œå®‰å…¨æ›´é‡è¦ã€‚â€</p>
<p>ä½ ä¸€è¾¹ç‚¹ç‚¹å¤´ï¼Œä¸€è¾¹ä¹ æƒ¯æ€§åœ°ç‚¹å¼€äº†æ‰‹æœºä¸Šçš„ Wi-Fi åˆ—è¡¨â€¦â€¦</p>
        `;
      },
      choices: [
        {
          text: "æŸ¥çœ‹æ‰‹æœºä¸Šçš„ Wi-Fi åˆ—è¡¨ã€‚",
          hint: "çœ‹çœ‹éƒ½æœ‰äº›ä»€ä¹ˆåå­—",
          next: "scene2_dorm_wifi"
        }
      ]
    },

    scene2_dorm_wifi: {
      id: "scene2_dorm_wifi",
      bg: "img/bg_dorm_corridor_night.jpg",
      bgm: "calm",
      tip:
        "æ˜¯å¦éœ€è¦å¯†ç ã€æ˜¯å¦æœ‰å°é”æ ‡å¿—ã€æ˜¯å¦æ˜¯ç†Ÿæ‚‰çš„å®˜æ–¹åå­—ï¼Œéƒ½æ˜¯åˆ¤æ–­ Wi-Fi æ˜¯å¦å¯é çš„é‡è¦çº¿ç´¢ã€‚",
         npcs: ["æ›¾é±¼å„¿"],
      text: function () {
        return `
<p>æ‰‹æœºå±å¹•ä¸Šè·³å‡ºäº†ä¸€ä¸²ç†Ÿæ‚‰å’Œé™Œç”Ÿçš„ç½‘ç»œåå­—ï¼š</p>
<p>Â· <span class="highlight">ZaoDorm_5F</span>ï¼ˆæœ‰å°é”å›¾æ ‡ï¼Œéœ€è¦å¯†ç ï¼‰</p>
<p>Â· <span class="highlight">ZaoFree5G</span>ï¼ˆå¼€æ”¾ç½‘ç»œï¼Œæ— ä»»ä½•åŠ å¯†æ ‡å¿—ï¼‰</p>
<p>Â· <span class="highlight">MiShare_XXX</span>ï¼ˆæŸä¸ªåŒå­¦æ‰‹æœºçƒ­ç‚¹ï¼‰</p>
<p class="aside">
ä½ æƒ³èµ·ä¿¡æ¯æŠ€æœ¯è¯¾ä¸Šæåˆ°è¿‡ï¼šå¼€æ”¾ Wi-Fi å’Œâ€œæ¥è·¯ä¸æ˜çƒ­ç‚¹â€éƒ½å¯èƒ½æ˜¯
<span class="highlight">æ¶æ„æ¥å…¥ç‚¹</span>ï¼ˆrogue APï¼‰ã€‚
</p>
        `;
      },
      choices: [
        {
          text: "â€œè¯•ä¸€ä¸‹è¿™ä¸ª ZaoFree5Gï¼Œå…è´¹åˆå¿«å¤šçˆ½ã€‚â€",
          hint: "è¿æ¥å¼€æ”¾ Wi-Fi",
          next: "scene2_wifi_rogue",
          effect: function () {
            addKnowledge("rogue_wifi");
          }
        },
        {
          text: "è€è€å®å®è¿ä¸Š ZaoDorm_5Fã€‚",
          hint: "åªç”¨å®˜æ–¹å®¿èˆ Wi-Fi",
          next: "scene2_dorm_wifi_safe",
          effect: function () {
            addKnowledge("privacy_settings");
          }
        },
        {
          text: "å…³æ‰ Wi-Fiï¼Œç”¨è‡ªå·±çš„æµé‡ç®—äº†ã€‚",
          hint: "ç‰ºç‰²ä¸€ç‚¹æµé‡æ¢ç¨³å¦¥",
          next: "scene2_dorm_wifi_safe",
          effect: function () {
            addKnowledge("privacy_settings");
          }
        }
      ]
    },

    scene2_wifi_rogue: {
      id: "scene2_wifi_rogue",
      bg: "img/bg_dorm_room_night.jpg",
      bgm: "tension",
      tip:
        "å‡çƒ­ç‚¹ + å‡ç™»å½•é¡µï¼Œæ˜¯å¸¸è§çš„å·å·ç»„åˆæ‹³ï¼šå…ˆéª—ä½ è¿ Wi-Fiï¼Œå†éª—ä½ è¾“å…¥è´¦å·å¯†ç ã€‚",
        npcs: ["æ›¾é±¼å„¿"], 
      text: function () {
        addKnowledge("rogue_wifi");
        return `
<p>ä½ ç‚¹äº† ZaoFree5Gã€‚</p>
<p>å‡ ç§’é’Ÿåï¼Œæµè§ˆå™¨è‡ªåŠ¨å¼¹å‡ºä¸€ä¸ªç™»é™†é¡µé¢ï¼Œæ ‡é¢˜å†™ç€ï¼š</p>
<p style="text-align:center;margin:4px 0;">
  <span class="highlight">â€œç±½å¥¥æ ¡å›­ç½‘å‡çº§ç³»ç»Ÿ Â· å­¦ç”Ÿå¿«é€Ÿè®¤è¯å…¥å£â€</span>
</p>
<p>ç•Œé¢çœ‹ä¸Šå»è¿˜ç®—â€œæ­£è§„â€ï¼Œè¦ä½ è¾“å…¥å­¦å·å’Œæ ¡å›­ç½‘å¯†ç ã€‚</p>
<p>ä½†ä½ æ³¨æ„åˆ°åœ°å€æ ï¼š<code>http://login-zao-free.net/portal</code>ï¼Œå‰é¢æ²¡æœ‰å°é”å›¾æ ‡ï¼ŒåŸŸåä¹Ÿä¸æ˜¯ä½ ç†Ÿæ‚‰çš„å­¦æ ¡åŸŸåã€‚</p>
<p class="aside">ä¿¡æ¯æŠ€æœ¯è¯¾ä¸Šè¯´è¿‡ï¼ŒçœŸæ­£çš„æ ¡å›­ç½‘ç™»é™†ä¸€èˆ¬ä¼šæ˜¯ <code>https://auth.zaohigh.edu...</code> ä¹‹ç±»ã€‚</p>
        `;
      },
      choices: [
        {
          text: "æ‡’å¾—å¤šæƒ³ï¼Œå…ˆæŠŠå­¦å·å’Œå¯†ç å¡«è¿›å»å†è¯´ã€‚",
          hint: "æ—¶é—´å®è´µï¼Œå®‰å…¨é è¿æ°”",
          next: "scene2_end_bad_stolen",
          effect: function () {
            addKnowledge("phishing_message");
            setProgress(100);
          }
        },
        {
          text: "ç­‰ç­‰ï¼Œå…ˆä»”ç»†çœ‹çœ‹ç½‘å€å’Œå°é”å›¾æ ‡ã€‚",
          hint: "æ£€æŸ¥æ˜¯å¦ä¸º HTTPSã€æ˜¯å¦æ˜¯æ­£ç¡®åŸŸå",
          next: "scene2_wifi_report",
          effect: function () {
            addKnowledge("https_ssl");
            addKnowledge("phishing_message");
            setProgress(90);
          }
        },
        {
          text: "æˆªå±å‘ç»™æ®·ç¼ºæ–¯æ±€ / é‡‘åèŠ±è€å¸ˆï¼šâ€œè¿™ä¸ªæ­£å¸¸å—ï¼Ÿâ€",
          hint: "æ±‚åŠ©ä¸“ä¸šäººå£«åˆ¤æ–­",
          next: "scene2_wifi_report",
          effect: function () {
            addKnowledge("phishing_message");
            setProgress(90);
          }
        }
      ]
    },

    scene2_dorm_wifi_safe: {
      id: "scene2_dorm_wifi_safe",
      bg: "img/bg_dorm_room_night.jpg",
      bgm: "calm",
      tip:
        "ä»»ä½•è¦æ±‚ä½ åœ¨é™Œç”Ÿé“¾æ¥é‡Œå¡«å†™å­¦å·ã€èº«ä»½è¯å·ã€å¯†ç çš„â€œç¦åˆ©â€ï¼Œéƒ½å€¼å¾—æ€€ç–‘æ˜¯ä¸æ˜¯ç½‘ç»œé’“é±¼ã€‚",
        npcs: ["æå°å‡¤"],
      text: function () {
        addKnowledge("privacy_settings");
        return `
<p>ä½ å†³å®šè¦ä¹ˆåªç”¨å®¿èˆå®˜æ–¹ Wi-Fiï¼Œè¦ä¹ˆå¹²è„†ç”¨è‡ªå·±çš„æµé‡ã€‚</p>
<p>åˆšæ‰“å¼€é¢˜åº“å‡†å¤‡åˆ·ä¸¤é“é¢˜ï¼Œç­çº§ç¾¤é‡Œçªç„¶è·³å‡ºä¸€æ¡æ–°çš„ç¾¤å…¬å‘Šï¼š</p>
<p style="border-left:3px solid #64b5f6;padding-left:8px;margin:6px 0;">
ã€ç³»ç»Ÿé€šçŸ¥ã€‘æœ¬å­¦æœŸä½“è‚²é•¿è·‘å¯ç”³è¯·<span class="highlight">å…æµ‹</span>ï¼Œ<br>
è¯·åœ¨ä»Šæ™š 23:00 å‰ç‚¹å‡»ä¸‹æ–¹é“¾æ¥å¡«å†™å­¦å·å’Œèº«ä»½è¯å·ã€‚<br>
ğŸ‘‰ <code>http://pe-free-test.cn/zao</code>
</p>
<p>å‘æ¶ˆæ¯çš„å¸å·å¤´åƒæ˜¯â€œæè€å¸ˆè·‘æ­¥ç¾¤â€ï¼Œå¤‡æ³¨çœ‹ä¸Šå»åƒä½“è‚²è€å¸ˆ<span class="highlight">æå°å‡¤</span>ã€‚</p>
<p class="aside">ä½†ä½ éšçº¦è®°å¾—ï¼šçœŸæ­£çš„ä½“è‚²é€šçŸ¥ä¸€èˆ¬ä¼šä»æ•™åŠ¡ç³»ç»Ÿæˆ–å­¦æ ¡å®˜æ–¹ App æ¨é€ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªé™Œç”Ÿç½‘å€ã€‚</p>
        `;
      },
      choices: [
        {
          text: "è¿™ä¸å°±æ˜¯å¤©é™ç¦åˆ©å—ï¼Ÿç«‹åˆ»ç‚¹è¿›å»å¡«å®Œã€‚",
          hint: "å…æµ‹è¯±æƒ‘å¤ªå¤§",
          next: "scene2_end_bad_datafarm",
          effect: function () {
            addKnowledge("phishing_message");
            setProgress(100);
          }
        },
        {
          text:
            "å…ˆçœ‹çœ‹ç½‘å€æ˜¯ä¸æ˜¯ HTTPSã€å°é”æ˜¯ä¸æ˜¯æ­£å¸¸ï¼Œå†ç§èŠçœŸæ­£çš„æè€å¸ˆç¡®è®¤ã€‚",
          hint: "å¤šä¸€æ­¥æ ¸å®ï¼Œå°‘å¾ˆå¤šéº»çƒ¦",
          next: "scene2_wifi_report",
          effect: function () {
            addKnowledge("https_ssl");
            addKnowledge("phishing_message");
            setProgress(90);
          }
        }
      ]
    },

    scene2_wifi_report: {
      id: "scene2_wifi_report",
      bg: "img/bg_office_night.jpg",
      bgm: "office",
      tip:
        "ä½ åˆšåˆšå®è·µäº†ä¸€ä¸ªé»„é‡‘æµç¨‹ï¼šå‘ç°å¼‚å¸¸ â†’ ä¸è´¸ç„¶æ“ä½œ â†’ æˆªå›¾/è®°å½• â†’ å‘å¯ä¿¡çš„æŠ€æœ¯/ç®¡ç†äººå‘˜æŠ¥å‘Šã€‚",
         npcs: ["æ®·ç¼ºæ–¯æ±€", "é‡‘åèŠ±è€å¸ˆ", "æ›¾é±¼å„¿"],
      text: function () {
        addKnowledge("rogue_wifi");
        addKnowledge("phishing_message");
        addKnowledge("https_ssl");
        return `
<p>ä¸ç®¡æ˜¯å¯ç–‘çš„ ZaoFree5G ç™»é™†é¡µï¼Œè¿˜æ˜¯é‚£æ¡â€œä½“è‚²å…æµ‹â€é“¾æ¥ï¼Œä½ æœ€ç»ˆéƒ½é€‰æ‹©äº†<span class="highlight">å…ˆç¡®è®¤</span>è€Œä¸æ˜¯ç›´æ¥æäº¤ä¿¡æ¯ã€‚</p>
<p>æ®·ç¼ºæ–¯æ±€è¿œç¨‹è¿ä¸Šæ›¾é±¼å„¿å€¼ç­å°ä¸Šçš„ç”µè„‘ï¼Œé‡‘åèŠ±è€å¸ˆåœ¨åå°ç›‘æ§æµé‡ã€‚</p>
<p class="npc">æ®·ç¼ºæ–¯æ±€ï¼š</p>
<p>â€œå—¯ï¼Œè¿™ä¸ªæ‰€è°“çš„â€˜ZaoFree5Gâ€™ç¡®å®æ˜¯åœ¨å¾€å¤–å‘ä¸œè¥¿ï¼Œç™»é™†é¡µé¢æŒ‚åœ¨ä¸€ä¸ªå»‰ä»·ä¸»æœºä¸Šã€‚â€</p>
<p class="npc">é‡‘åèŠ±è€å¸ˆï¼š</p>
<p>â€œå¥½åœ¨ç›®å‰åªæœ‰å°‘é‡è®¾å¤‡è¿è¿‡å»ï¼Œæˆ‘ä»¬å¯ä»¥è®©é˜²ç«å¢™ç›´æ¥å°è¿™ä¸ª MAC å’Œ IP æ®µã€‚â€</p>
<p>ä»–ä»¬åˆå¯¹é‚£æ¡â€œä½“è‚²å…æµ‹â€é“¾æ¥åšäº†å¿«é€Ÿåˆ†æï¼Œç¡®è®¤æ˜¯ä¸€ä¸ªæ•°æ®æ”¶é›†ç«™ç‚¹ï¼Œä¸“é—¨å¥—è·¯å­¦ç”Ÿå¡«ä¸ªäººä¿¡æ¯ã€‚</p>
<p class="npc">æ®·ç¼ºæ–¯æ±€ï¼š</p>
<p>â€œç½‘ç»œé’“é±¼ä¸åªåœ¨é‚®ä»¶é‡Œï¼Œç¾¤èŠã€çŸ­ä¿¡ã€å‡çƒ­ç‚¹éƒ½å¯ä»¥ã€‚ä½ è¿™æ¬¡ååº”ä¸é”™ã€‚â€</p>
        `;
      },
      choices: [
        {
          text: "é…åˆä»–ä»¬å†™ä¸€ä»½ã€Šå®¿èˆç½‘ç»œå®‰å…¨æé†’ã€‹ï¼Œå‡†å¤‡å‘ç»™å…¨ä½“åŒå­¦ã€‚",
          hint: "ç¬¬äºŒç« å¥½ç»“å±€",
          next: "scene2_end_good",
          effect: function () {
            setProgress(100);
          }
        }
      ]
    },

    scene2_end_good: {
      id: "scene2_end_good",
      bg: "img/bg_campus_night.jpg",
      bgm: "calm",
      tip:
        "ä½ è§£é”äº†å¤šä¸ªä¸ Wi-Fi å’Œç½‘ç»œé’“é±¼ç›¸å…³çš„çŸ¥è¯†ç‚¹ï¼Œå¯ä»¥åœ¨æˆå°±é¢æ¿é‡Œå›é¡¾ã€‚",
      endingKey: "good",
         npcs: ["æ›¾é±¼å„¿", "æ®·ç¼ºæ–¯æ±€", "é‡‘åèŠ±è€å¸ˆ", "çš‡å¤ªå­ï¼ˆçŒ«ï¼‰"],
      text: function () {
        return `
<p>ç¬¬äºŒå¤©ä¸€æ—©ï¼Œå®¿èˆæ¥¼ç”µæ¢¯å£è´´å‡ºäº†æ–°çš„æ¸©é¦¨æç¤ºï¼š</p>
<p style="text-align:center;margin:4px 0;">
<span class="highlight">â€œè¯·å‹¿è¿æ¥æ¥è·¯ä¸æ˜ Wi-Fiï¼›æ…ç‚¹ä»»ä½•è¦æ±‚å¡«å†™è´¦å·å¯†ç å’Œè¯ä»¶å·ç çš„å¤–éƒ¨é“¾æ¥ã€‚â€</span>
</p>
<p>ä¿¡æ¯ç»„ä¹Ÿåœ¨æ ¡å›­ç½‘é¦–é¡µå‘å¸ƒäº†ä¸€ç¯‡ã€Šå¦‚ä½•è¯†åˆ«æ¶æ„çƒ­ç‚¹ä¸ç½‘ç»œé’“é±¼ã€‹çš„å°ç§‘æ™®ï¼Œå…¶ä¸­æœ‰ä¸€æ®µç½²åæ˜¯ä½ å’Œæ›¾é±¼å„¿å…±åŒå®Œæˆçš„â€œå­¦ç”Ÿè§†è§’å»ºè®®â€ã€‚</p>
<p>çš‡å¤ªå­åœ¨å…¬å‘Šæ ä¸‹é¢æ‰“äº†ä¸ªæ»šï¼Œé¡ºä¾¿æŠŠè§’è½é‡Œçš„ä¸€å¼ å°å¹¿å‘Šè¸¢è¿›äº†åƒåœ¾æ¡¶ã€‚</p>
<p class="aside">è‡³å°‘åœ¨æ¥ä¸‹æ¥çš„å¾ˆé•¿ä¸€æ®µæ—¶é—´é‡Œï¼Œå®¿èˆæ¥¼çš„â€œZaoFree5Gâ€å†ä¹Ÿæ²¡æœ‰å‡ºç°è¿‡ã€‚</p>
<p class="ending-banner ending-good">
  <span class="ending-label">GOOD END</span>
  <span>ç¬¬ 2 ç«  Â· å®¿èˆé‡Œçš„é™Œç”Ÿ Wi-Fi</span>
</p>
        `;
      },
      choices: [
        {
          text: "é‡æ–°ä½“éªŒç¬¬ 2 ç« ï¼Œçœ‹çœ‹ä¸åŒçš„é”™è¯¯ä¼šå‘ç”Ÿä»€ä¹ˆã€‚",
          hint: "ä¿ç•™å½“å‰æˆå°±ï¼Œä»ç¬¬äºŒç« å¼€å¤´æ¥",
          next: "scene2_intro"
        },
        {
          text: "å›åˆ°ç¬¬ 1 ç« ï¼ˆindex.htmlï¼‰ï¼Œä»æœºæˆ¿é‚£ä¸€å¤œé‡æ–°æ€è€ƒã€‚",
          hint: "éœ€è¦æ‰‹åŠ¨æ‰“å¼€ index.html",
          next: "scene2_intro",
          effect: function () {
            // å¯é€‰ï¼šè¿™é‡Œå¯ä»¥æç¤ºç©å®¶å»æ‰“å¼€ index.html
            alert("è¯·åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ index.html é‡æ–°ä½“éªŒç¬¬ 1 ç« ã€‚");
          }
        }
      ]
    },

    scene2_end_bad_stolen: {
      id: "scene2_end_bad_stolen",
      bg: "img/bg_dorm_room_night.jpg",
      bgm: "tension",
      tip:
        "è®°ä½ï¼šå‡çƒ­ç‚¹ + å‡ç™»å½•é¡µï¼Œæ˜¯æœ€å¸¸è§çš„å·å·å¥—è·¯ä¹‹ä¸€ã€‚",
      endingKey: "bad_stolen",
        npcs: ["æ®·ç¼ºæ–¯æ±€"],
      text: function () {
        return `
<p>ä½ åœ¨ ZaoFree5G çš„ç™»é™†é¡µä¸Šé£å¿«åœ°è¾“å…¥äº†å­¦å·å’Œæ ¡å›­ç½‘å¯†ç ã€‚</p>
<p>å½“å¤©æ™šä¸Šä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿï¼Œç¬¬äºŒå¤©ä½ å´å‘ç°é‚®ç®±é‡Œå¤šäº†å‡ åå°é‚®ä»¶é€€ä¿¡ï¼šä½ çš„è´¦å·åœ¨åŠå¤œç»™æ— æ•°é™Œç”Ÿåœ°å€å‘å‡ºäº†åƒåœ¾é‚®ä»¶å’Œé’“é±¼é“¾æ¥ã€‚</p>
<p>ä¿¡æ¯ç»„å¸®ä½ ç´§æ€¥é‡ç½®äº†å¯†ç ï¼Œå¹¶æ¸…ç†äº†ç›¸å…³æ—¥å¿—ï¼Œä½†é‚£ä¸²æ—§å¯†ç å·²ç»è¢«åˆ«äººæ‹¿èµ°ï¼Œå¯èƒ½è¿˜è¢«å–ç»™äº†æ›´å¤šäººã€‚</p>
<p class="aside">å¥½æ¶ˆæ¯æ˜¯ï¼Œè¿™æ¬¡å½±å“ä¸»è¦é›†ä¸­åœ¨ä½ çš„è´¦å·ï¼›åæ¶ˆæ¯æ˜¯ï¼Œè¿™ç§â€œå·å· + åƒåœ¾é‚®ä»¶â€åªæ˜¯ç½‘ç»œæ”»å‡»é‡Œæœ€æ¸©æŸ”çš„ä¸€ç§ã€‚</p>
<p class="ending-banner ending-bad">
  <span class="ending-label">BAD END 1</span>
  <span>ç¬¬ 2 ç«  Â· è´¦å·è¢«ç›—ç”¨</span>
</p>

        `;
      },
      choices: [
        {
          text: "å›åˆ°å®¿èˆé‚£ä¸€æ™šï¼Œä»é€‰æ‹© Wi-Fi å¼€å§‹é‡æ¥ã€‚",
          hint: "ç¬¬äºŒç« ä¸­é€”é‡å¼€",
          next: "scene2_dorm_wifi"
        },
        {
          text: "æš‚æ—¶åœä¸€ä¸‹ï¼Œæ¶ˆåŒ–è¿™ä¸ªæ•™è®­ã€‚",
          hint: "ä½ å¯ä»¥ç¨åå†å›æ¥",
          next: "scene2_dorm_wifi"
        }
      ]
    },

    scene2_end_bad_datafarm: {
      id: "scene2_end_bad_datafarm",
      bg: "img/bg_dorm_room_night.jpg",
      bgm: "tension",
      tip:
        "ä»»ä½•è¦æ±‚ä½ åœ¨é™Œç”Ÿç½‘é¡µå¡«å†™å¤§é‡ä¸ªäººä¿¡æ¯çš„â€œå¥½äº‹â€ï¼Œéƒ½è¦å°å¿ƒæ˜¯ä¸æ˜¯åœ¨ç»™æ•°æ®å†œåœºå…è´¹æ‰“å·¥ã€‚",
      endingKey: "bad_datafarm",
        npcs: ["æå°å‡¤"],
      text: function () {
        return `
<p>ä½ åœ¨é‚£ä»½æ‰€è°“çš„â€œä½“è‚²å…æµ‹ç”³è¯·è¡¨â€é‡Œï¼Œè€è€å®å®å¡«ä¸Šäº†å­¦å·ã€å§“åã€èº«ä»½è¯å·ï¼Œç”šè‡³è¿˜é™„å¸¦äº†å®¶åº­ä½å€ã€‚</p>
<p>å‡ å¤©ä¹‹å†…ï¼Œæ‰‹æœºå¼€å§‹æ¥åˆ°å„ç§â€œé’ˆå¯¹å­¦ç”Ÿçš„è´·æ¬¾äº§å“â€â€œç«èµ›åŸ¹è®­ä¼˜æƒ â€çš„ç”µè¯å’ŒçŸ­ä¿¡ï¼Œè¿çˆ¶æ¯éƒ½æ”¶åˆ°äº†ç±»ä¼¼æ¨é”€ã€‚</p>
<p>çœŸæ­£çš„ä½“è‚²è€å¸ˆæå°å‡¤åœ¨ç­ä¼šä¸Šæ— å¥ˆåœ°æ¾„æ¸…ï¼š</p>
<p class="npc">æå°å‡¤ï¼š</p>
<p>â€œå­¦æ ¡ä¸ä¼šç”¨è¿™ç§é™Œç”Ÿç½‘å€æ”¶é›†ä½ ä»¬çš„è¯ä»¶å·ç ï¼Œä¸‹æ¬¡é‡åˆ°ç±»ä¼¼é“¾æ¥ï¼Œä¸€å®šè¦å¤šé—®ä¸€å¥ã€‚â€</p>
<p class="aside">ä½ ç»ˆäºæ„è¯†åˆ°ï¼Œä¸ªäººä¿¡æ¯ä¸€æ—¦æ³„éœ²ï¼Œå°±å¾ˆéš¾çœŸæ­£â€œæ”¶å›â€ã€‚</p><p class="ending-banner ending-bad">
  <span class="ending-label">BAD END 2</span>
  <span>ç¬¬ 2 ç«  Â· æ•°æ®å†œåœºçš„å…»åˆ†</span>
</p>
`;
      },
      choices: [
        {
          text: "å›åˆ°çœ‹åˆ°é‚£æ¡ä½“è‚²å…æµ‹é“¾æ¥çš„æ—¶åˆ»ã€‚",
          hint: "å›åˆ°ç¬¬äºŒç« ä¸­æ®µ",
          next: "scene2_dorm_wifi_safe"
        },
        {
          text: "æš‚æ—¶åœä¸€ä¸‹ï¼Œå›å»å’ŒåŒå­¦èŠèŠç±»ä¼¼ç»å†ã€‚",
          hint: "ä½ å¯ä»¥ç¨åå†å›æ¥",
          next: "scene2_dorm_wifi_safe"
        }
      ]
    }
  };

  // ========= æ¸²æŸ“é€»è¾‘ =========
  const npcDialogCard = document.getElementById("npc-dialog-card");
  const npcDialogAvatar = document.getElementById("npc-dialog-avatar");
  const npcDialogName = document.getElementById("npc-dialog-name");
  const npcDialogRole = document.getElementById("npc-dialog-role");
  const sceneTextEl = document.getElementById("scene-text");
  const choiceListEl = document.getElementById("choice-list");
  const tipBarEl = document.getElementById("tip-bar");
  const settlementPanel = document.getElementById("settlement-panel");
  const settlementBadgeEl = document.getElementById("settlement-badge");
  const settlementTitleEl = document.getElementById("settlement-title");
  const settlementDescEl = document.getElementById("settlement-desc");
  const settlementStatsEl = document.getElementById("settlement-stats");
  const settlementScoreEl = document.getElementById("settlement-score");
  const settlementScoreHintEl = document.getElementById(
    "settlement-score-hint"
  );

  function hideSettlementPanel() {
    if (settlementPanel) settlementPanel.classList.add("hidden");
  }

  function showSettlementPanel(key) {
    if (
      !settlementPanel ||
      !settlementBadgeEl ||
      !settlementTitleEl ||
      !settlementDescEl ||
      !settlementStatsEl ||
      !settlementScoreEl ||
      !settlementScoreHintEl
    )
      return;

    const knowledgeCount = state.knowledge ? state.knowledge.size : 0;
    const knowledgeTotal = Object.keys(knowledgeData).length;
    const scoreBase = key === "good" ? 95 : 65;
    const bonus = Math.min(knowledgeCount * 3, 12);
    const finalScore = Math.min(100, scoreBase + bonus);

    const config = {
      good: {
        badge: "æˆåŠŸç»“ç®—",
        badgeClass: "settlement-badge settlement-badge-good",
        title: "å®¿èˆç½‘ç»œå®‰å…¨å®ˆæŠ¤æˆåŠŸ",
        desc: "ä½ é¿å¼€äº†å‡çƒ­ç‚¹å’Œé’“é±¼é“¾æ¥ï¼Œå¹¶æŠŠå‘ç°æŠ¥å‘Šç»™äº†ä¿¡æ¯ç»„ã€‚",
        hint: "åšå¾—å¥½ï¼ä¿æŒè­¦æƒ•ï¼Œç»§ç»­åˆ†äº«ç»éªŒã€‚"
      },
      bad_stolen: {
        badge: "å¤±è´¥ç»“ç®—",
        badgeClass: "settlement-badge settlement-badge-bad",
        title: "è´¦å·è¢«ç›—ç”¨",
        desc: "å­¦å·ä¸å¯†ç è½å…¥æ”»å‡»è€…ä¹‹æ‰‹ï¼Œäº§ç”Ÿåƒåœ¾é‚®ä»¶ä¸æ½œåœ¨æ»¥ç”¨ã€‚",
        hint: "æ³¨æ„æ£€æŸ¥ç½‘å€å°é”ä¸åŸŸåï¼Œåˆ«åœ¨é™Œç”Ÿé¡µé¢è¾“å…¥å‡­æ®ã€‚"
      },
      bad_datafarm: {
        badge: "å¤±è´¥ç»“ç®—",
        badgeClass: "settlement-badge settlement-badge-bad",
        title: "æˆä¸ºæ•°æ®å†œåœºçš„ç›®æ ‡",
        desc: "ä¸ªäººä¿¡æ¯è¢«æ‰¹é‡æ”¶é›†åï¼Œå¼€å§‹æ”¶åˆ°æ¨é”€ä¸éªšæ‰°ã€‚",
        hint: "é™Œç”Ÿè¡¨å•æ…å¡«è¯ä»¶å·ï¼›å…ˆå‘è€å¸ˆæˆ–å®˜æ–¹æ¸ é“æ ¸å®ã€‚"
      }
    }[key] || {
      badge: "ç»“å±€",
      badgeClass: "settlement-badge",
      title: "ç¬¬äºŒç« ç»“å±€",
      desc: "",
      hint: ""
    };

    settlementBadgeEl.className = config.badgeClass;
    settlementBadgeEl.textContent = config.badge;
    settlementTitleEl.textContent = config.title;
    settlementDescEl.textContent = config.desc;
    settlementScoreHintEl.textContent = config.hint;
    settlementScoreEl.textContent = finalScore;

    settlementStatsEl.innerHTML = `
      <li>è§£é”çŸ¥è¯†ç‚¹ï¼š${knowledgeCount}/${knowledgeTotal}</li>
      <li>ä¿¡ä»»Â·æ®·è€å¸ˆï¼š${state.trustYin ?? 0}</li>
      <li>ä¿¡ä»»Â·é‡‘è€å¸ˆï¼š${state.trustJin ?? 0}</li>
      <li>ç¬¬äºŒç« è¿›åº¦ï¼š${state.progress ?? 0}%</li>
    `;

    settlementPanel.classList.remove("hidden");
  }

  function showPage(scene, pageIndex) {
    currentPageIndex = pageIndex;
    const html = currentPages[pageIndex] || "";
    const key = scene.id + "_p" + pageIndex;

    updateNpcDialogFromHtml(html);

    choiceListEl.innerHTML = "";

    typeWriter(html, sceneTextEl, key, () => {
      if (pageIndex < currentPages.length - 1) {
        // ä¸­é—´é¡µï¼Œåªæ˜¾ç¤ºâ€œç»§ç»­â€
        const btn = document.createElement("button");
        btn.className = "choice-button";
        const labelSpan = document.createElement("span");
        labelSpan.className = "label";
        const hintSpan = document.createElement("span");
        hintSpan.className = "hint";
        hintSpan.textContent = "ä¸‹ä¸€é¡µ";

        btn.appendChild(labelSpan);
        btn.appendChild(hintSpan);
        choiceListEl.appendChild(btn);

        setTimeout(() => {
          if (currentSceneId !== scene.id) return;
          btn.classList.add("visible");
          typeChoiceLabel(
            "ç»§ç»­",
            labelSpan,
            scene.id + "_page_next_" + pageIndex
          );
        }, 200);

        btn.addEventListener("click", () => {
          playSfx("choice");
          showPage(scene, pageIndex + 1);
        });
      } else {
        // æœ€åä¸€é¡µï¼Œæ˜¾ç¤ºçœŸæ­£çš„é€‰é¡¹
        (scene.choices || []).forEach((choiceObj, index) => {
          const btn = document.createElement("button");
          btn.className = "choice-button";
          const labelSpan = document.createElement("span");
          labelSpan.className = "label";
          const hintSpan = document.createElement("span");
          hintSpan.className = "hint";
          hintSpan.textContent = choiceObj.hint || "";

          btn.appendChild(labelSpan);
          btn.appendChild(hintSpan);
          choiceListEl.appendChild(btn);

          btn.addEventListener("click", () => {
            playSfx("choice");
            if (typeof choiceObj.effect === "function") {
              choiceObj.effect(state);
            }
            updateStatusBar();
            renderScene(choiceObj.next);
          });

          const baseDelay = 220;
          setTimeout(() => {
            if (currentSceneId !== scene.id) return;
            btn.classList.add("visible");
            typeChoiceLabel(
              choiceObj.text,
              labelSpan,
              scene.id + "_choice_" + index
            );
          }, baseDelay * index + 150);
        });
      }
    });
  }

  function renderScene(id) {
    const scene = scenes[id];
    if (!scene) {
      console.warn("æœªæ‰¾åˆ°åœºæ™¯ï¼š", id);
      return;
    }
    currentSceneId = id;

        if (scene.npcs) {
      handleNpcIntro(scene.npcs);
    }
    setBackgroundImage(scene.bg);
    playBgm(scene.bgm || "calm");

    const rawHtml =
      typeof scene.text === "function" ? scene.text(state) : scene.text;
    currentPages = paginateSceneText(rawHtml || "");
    currentPageIndex = 0;

    if (tipBarEl) {
      tipBarEl.textContent =
        scene.tip ||
        "æç¤ºï¼šæ³¨æ„ Wi-Fi åç§°ã€ç½‘å€çš„å°é”ç¬¦å·ï¼Œä»¥åŠå„ç§â€œå¥½å¾—è¿‡å¤´â€çš„ç¦åˆ©ã€‚";
    }

    hideSettlementPanel();
    if (scene.endingKey) {
      showSettlementPanel(scene.endingKey);
    }

    updateStatusBar();
    showPage(scene, 0);
  }

  // ========= UI äº¤äº’ =========
  const metaToggle = document.getElementById("meta-toggle");
  const uiMeta = document.getElementById("ui-meta");
  const achToggle = document.getElementById("achievements-toggle");
  const achPanel = document.getElementById("achievements-panel");

  metaToggle.addEventListener("click", () => {
    uiMeta.classList.toggle("hidden");
  });

  achToggle.addEventListener("click", () => {
    achPanel.classList.toggle("hidden");
  });

  // ========= å¼€å§‹é€»è¾‘ =========
  const startScreen = document.getElementById("start-screen");
  const gameUi = document.getElementById("game-ui");
  const btnStartLoad = document.getElementById("btn-start-load");
  const btnStartFresh = document.getElementById("btn-start-fresh");

  function startGame() {
    startScreen.classList.add("hidden");
    gameUi.classList.remove("hidden");
    renderAchievementsPanel();
    updateStatusBar();
    renderScene("scene2_intro");
  }

  btnStartLoad.addEventListener("click", () => {
    loadGameFromLocal();
    startGame();
  });

  btnStartFresh.addEventListener("click", () => {
    // ä¸è¯»æ¡£ï¼Œç›´æ¥å¼€å§‹
    startGame();
  });

  // åˆå§‹èƒŒæ™¯å›¾
  setBackgroundImage("img/bg_campus_night.jpg");
</script>
</body>
</html>
