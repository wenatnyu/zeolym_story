<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <!-- æ–°å¢ï¼šè®©æ‰‹æœºæŒ‰è®¾å¤‡å®½åº¦æ¸²æŸ“ï¼Œè€Œä¸æ˜¯ç¼©æˆâ€œæ¡Œé¢æ¨¡å¼â€ -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>ç±½å¥¥ä¸­å­¦ç½‘ç»œå®‰å…¨å†’é™© Â· ç¬¬1ç«  æœºæˆ¿çš„å¥‡æ€ªä¸€å¤œ</title>
  <style>

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft Yahei", sans-serif;
      background: radial-gradient(circle at top, #1b2735, #090a0f);
      color: #f5f5f5;
    }
    .game-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 10px;
    }
    .game-card {
      position: relative;
      width: 100%;
      max-width: 900px;
      border-radius: 18px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(120, 190, 255, 0.35);
      overflow: hidden;
      background: rgba(15, 22, 36, 0.97);
    }
    .game-bg {
  position: absolute;
  inset: 0;
  background-size: cover;
  background-position: center;
  /* æ¨¡ç³Šå’Œå˜æš—å‡å¼±ï¼Œè®©å›¾ç‰‡æ›´æ˜æ˜¾ */
  filter: blur(3px) brightness(0.8);
  filter: blur(2px) brightness(0.9);

  opacity: 0.95;
  z-index: 0;
  transition: background-image 0.2s ease-out;
}

.game-content {
  position: relative;
  z-index: 1;
  padding: 18px 18px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;

  /* æ”¹æˆåŠé€æ˜é®ç½©ï¼Œèƒ½æ¸…æ¥šçœ‹åˆ°èƒŒæ™¯å›¾ */
  background: linear-gradient(
    to bottom,
    rgba(7, 12, 24, 0.40),
    rgba(7, 12, 24, 0.75)
  );
  background: rgba(7, 12, 24, 0.55);

}

    /* é¡¶éƒ¨ NPC å¯¹è¯ headerï¼ˆæ²‰æµ¸ï¼‰ */
    .npc-dialogue-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 12px;
      background: radial-gradient(circle at top left, rgba(63, 81, 181, 0.6), rgba(13, 28, 56, 0.95));
      border: 1px solid rgba(144, 202, 249, 0.9);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }
    .npc-avatar {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      background: radial-gradient(circle at 20% 0%, #bbdefb, #1e88e5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      color: #0b1b30;
      overflow: hidden;
      cursor: pointer;
    }
    .npc-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .npc-info-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .npc-name { font-size: 15px; font-weight: 600; }
    .npc-role { font-size: 11px; opacity: 0.85; }

    .scene-text {
      min-height: 220px;
      max-height: 430px;
      overflow: hidden;
      padding-right: 4px;
      line-height: 1.7;
      font-size: 15px;
      font-variant-numeric: lining-nums;
      white-space: pre-wrap;
    }
    .scene-text p { margin: 0 0 8px; }
    .scene-text p:last-child { margin-bottom: 0; }
    .scene-text .npc { font-weight: 600; color: #8fd3ff; }
    .scene-text .aside { font-size: 13px; opacity: 0.9; font-style: italic; }
    .scene-text .highlight { color: #ffe082; font-weight: 600; }

    .typing-caret::after {
      content: "â–‹";
      margin-left: 2px;
      animation: caretBlink 0.9s steps(1) infinite;
      opacity: 0.7;
    }
    @keyframes caretBlink {
      0%, 50% { opacity: 0.7; }
      51%, 100% { opacity: 0; }
    }

    .choice-list {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .choice-button {
      width: 100%;
      text-align: left;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(144, 206, 255, 0.65);
      background: linear-gradient(135deg, rgba(29, 53, 87, 0.96), rgba(27, 38, 79, 0.96));
      color: #f5f5f5;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;

      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.2s ease-out, transform 0.2s ease-out, box-shadow 0.08s ease-out, background 0.12s ease-out;
    }
    .choice-button.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .choice-button span.label {
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .choice-button span.hint {
      font-size: 11px;
      opacity: 0.75;
      white-space: nowrap;
      margin-left: 6px;
    }
    .choice-button:hover {
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.4);
      background: linear-gradient(135deg, rgba(46, 70, 110, 0.98), rgba(27, 47, 94, 0.98));
    }
    .choice-button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .ui-toggle {
      position: fixed;
      left: 12px;
      top: 14px;
      z-index: 930;
      border-radius: 999px;
      border: 1px solid rgba(200, 230, 255, 0.9);
      background: rgba(11, 31, 53, 0.96);
      color: #e3f2fd;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.6);
    }

    .ui-panel {
      position: fixed;
      inset: 0;
      background: rgba(3, 8, 20, 0.86);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 940;
    }
    .ui-panel.active {
      display: flex;
    }
    .ui-panel-inner {
      width: 94%;
      max-width: 920px;
      max-height: 85vh;
      background: rgba(10, 17, 33, 0.98);
      border-radius: 18px;
      border: 1px solid rgba(120, 190, 255, 0.8);
      box-shadow: 0 16px 40px rgba(0,0,0,0.7);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: auto;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid rgba(120, 190, 255, 0.45);
      padding-bottom: 4px;
    }
    .game-title { font-size: 18px; font-weight: 600; letter-spacing: 0.04em; }
    .game-subtitle { font-size: 12px; opacity: 0.78; }
    .game-status {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      justify-content: flex-end;
    }
    .status-pill {
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(44, 116, 179, 0.5);
      border: 1px solid rgba(144, 206, 255, 0.6);
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .status-label { opacity: 0.8; }
    .status-value { font-weight: 600; }

    .music-toggle {
      border-radius: 999px;
      border: 1px solid rgba(200, 230, 255, 0.9);
      background: rgba(11, 31, 53, 0.95);
      color: #e3f2fd;
      padding: 3px 9px;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .bottom-info {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }
    .sidebar-box {
      flex: 1;
      min-width: 0;
      border-radius: 10px;
      padding: 8px 9px;
      background: rgba(12, 25, 45, 0.9);
      border: 1px solid rgba(94, 155, 216, 0.7);
      font-size: 12px;
    }
    .sidebar-section-title {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 2px;
    }
    .sidebar-list {
      margin: 0;
      padding-left: 16px;
    }
    .sidebar-list li { margin-bottom: 3px; }
    .npc-tag { font-weight: 600; color: #8fd3ff; }
    .footer-hint {
      margin-top: 4px;
      font-size: 11px;
      opacity: 0.72;
      text-align: right;
    }

    .ui-close-row {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 4px;
    }
    .btn-close-ui {
      border-radius: 999px;
      border: 1px solid rgba(200, 230, 255, 0.9);
      background: transparent;
      color: #e3f2fd;
      width: 26px;
      height: 26px;
      cursor: pointer;
      font-size: 14px;
    }

    .achievements-toggle {
      position: fixed;
      right: 12px;
      bottom: 14px;
      z-index: 900;
      border-radius: 999px;
      border: 1px solid rgba(255, 235, 130, 0.8);
      background: radial-gradient(circle at top, #ffe57f, #ff9100);
      color: #222;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .achievements-toggle span.icon { font-size: 14px; }
    .achievements-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 9px 22px rgba(0, 0, 0, 0.6);
    }
    .achievements-toggle.pulse {
      animation: pulseButton 0.7s ease-out;
    }
    @keyframes pulseButton {
      0% { transform: scale(1); box-shadow: 0 6px 16px rgba(0,0,0,0.5); }
      50% { transform: scale(1.08); box-shadow: 0 10px 24px rgba(0,0,0,0.7); }
      100% { transform: scale(1); box-shadow: 0 6px 16px rgba(0,0,0,0.5); }
    }

    .achievements-panel {
      position: fixed;
      inset: 0;
      background: rgba(3, 8, 20, 0.86);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 950;
    }
    .achievements-panel.active { display: flex; }
  .achievements-content {
    width: 90%;
    max-width: 520px;
    max-height: 80vh;
    background: rgba(10, 17, 33, 0.98);
      border-radius: 18px;
      border: 1px solid rgba(255, 235, 130, 0.9);
      box-shadow: 0 16px 40px rgba(0,0,0,0.7);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .achievements-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid rgba(255, 235, 130, 0.5);
      padding-bottom: 4px;
    }
    .achievements-header-title { font-size: 14px; font-weight: 600; }
    .achievements-close-btn {
      border-radius: 999px;
      border: 1px solid rgba(255, 235, 130, 0.9);
      background: transparent;
      color: #ffe082;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 14px;
    }
    .achievements-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      font-size: 13px;
    }
    .achievement-item {
      border-radius: 10px;
      border: 1px solid rgba(255, 235, 130, 0.6);
      padding: 6px 8px;
      margin-bottom: 6px;
      background: rgba(30, 26, 8, 0.85);
    }
    .achievement-name-zh { font-weight: 600; margin-bottom: 2px; }
    .achievement-name-en { font-size: 12px; opacity: 0.85; }
    .achievement-desc { font-size: 12px; opacity: 0.9; margin-top: 2px; }

    .achievement-flash-overlay {
      position: fixed;
      inset: 0;
      background: rgba(3, 8, 20, 0.88);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 960;
      pointer-events: none;
    }
    .achievement-flash-card {
      background: radial-gradient(circle at top, #fff8e1, #ffb300);
      color: #221400;
      border-radius: 20px;
      padding: 18px 20px;
      border: 2px solid #ffe082;
      box-shadow: 0 16px 40px rgba(0,0,0,0.75);
      max-width: 480px;
      text-align: left;
      transform: translate3d(0,0,0) scale(1);
      opacity: 1;
      transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
    }
    .achievement-flash-title { font-size: 13px; opacity: 0.9; margin-bottom: 4px; }
    .achievement-flash-name { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
    .achievement-flash-name-en { font-size: 13px; opacity: 0.9; margin-bottom: 6px; }
    .achievement-flash-desc { font-size: 13px; opacity: 0.9; }
    .achievement-flash-footer { font-size: 12px; opacity: 0.9; margin-top: 6px; }

    .npc-intro-overlay {
      position: fixed;
      inset: 0;
      background: rgba(3, 8, 20, 0.78);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 955;
      pointer-events: none;
    }
    .npc-intro-card {
      background: radial-gradient(circle at top, #e3f2fd, #90caf9);
      color: #0b1b30;
      border-radius: 22px;
      padding: 16px 18px;
      border: 2px solid #bbdefb;
      box-shadow: 0 16px 40px rgba(0,0,0,0.75);
      max-width: 420px;
      display: flex;
      align-items: center;
      gap: 12px;
      transform: scale(0.85);
      opacity: 0;
      transition: transform 0.35s ease-out, opacity 0.35s ease-out;
    }
    .npc-intro-card.active {
      transform: scale(1);
      opacity: 1;
    }
    .npc-intro-avatar {
      width: 60px;
      height: 60px;
      border-radius: 18px;
      background: radial-gradient(circle at 20% 0%, #ffffff, #64b5f6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      font-weight: 700;
      overflow: hidden;
    }
    .npc-intro-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .npc-intro-main {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .npc-intro-tag { font-size: 12px; opacity: 0.9; }
    .npc-intro-name { font-size: 16px; font-weight: 700; }
    .npc-intro-role { font-size: 13px; }
    .npc-intro-desc { font-size: 12px; opacity: 0.9; }

    /* NPC è¯¦æƒ…å¼¹å±‚ï¼ˆç‚¹å‡»å¤´åƒæŸ¥çœ‹ï¼‰ */
    .npc-detail-overlay {
      position: fixed;
      inset: 0;
      background: rgba(3, 8, 20, 0.82);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 965;
    }
    .npc-detail-card {
      width: min(540px, 92%);
      background: linear-gradient(135deg, rgba(9, 18, 32, 0.96), rgba(10, 25, 47, 0.94));
      border-radius: 20px;
      border: 1px solid rgba(144, 202, 249, 0.9);
      box-shadow: 0 20px 50px rgba(0,0,0,0.75);
      padding: 14px 16px;
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 12px;
      color: #e3f2fd;
      position: relative;
      overflow: hidden;
    }
    .npc-detail-card::before {
      content: "";
      position: absolute;
      inset: -20% 40% auto -10%;
      height: 180px;
      background: radial-gradient(circle at center, rgba(100, 181, 246, 0.4), transparent 65%);
      pointer-events: none;
    }
    .npc-detail-avatar {
      width: 120px;
      height: 120px;
      border-radius: 18px;
      background: radial-gradient(circle at 20% 0%, #bbdefb, #1e88e5);
      overflow: hidden;
      border: 2px solid rgba(191, 219, 254, 0.9);
      box-shadow: 0 12px 30px rgba(0,0,0,0.5);
    }
    .npc-detail-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .npc-detail-main { display: flex; flex-direction: column; gap: 6px; position: relative; z-index: 1; }
    .npc-detail-name { font-size: 20px; font-weight: 800; letter-spacing: 0.04em; }
    .npc-detail-role { font-size: 13px; opacity: 0.9; }
    .npc-detail-desc { font-size: 13px; color: #cbd5e1; line-height: 1.55; }
    .npc-detail-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .npc-detail-tag {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(144, 202, 249, 0.6);
      color: #dbeafe;
    }
    .npc-detail-close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 1px solid rgba(191, 219, 254, 0.8);
      background: rgba(11, 23, 40, 0.9);
      color: #e3f2fd;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ç»“å±€ç‰¹æ•ˆå±‚ */
    .ending-effects {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 940;
    }
    .ending-effects.ending-bad::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 30% 30%, rgba(239, 68, 68, 0.22), transparent 45%),
        radial-gradient(circle at 70% 40%, rgba(248, 113, 113, 0.18), transparent 45%),
        rgba(120, 20, 20, 0.18);
      mix-blend-mode: screen;
      animation: badPulse 1.6s ease-in-out infinite alternate;
    }
    @keyframes badPulse {
      from { opacity: 0.7; filter: saturate(1); }
      to { opacity: 1; filter: saturate(1.25); }
    }

    .ending-effects.ending-good .spark {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: radial-gradient(circle, #fef08a 40%, rgba(255, 255, 255, 0));
      box-shadow: 0 0 12px rgba(251, 191, 36, 0.9), 0 0 22px rgba(59, 130, 246, 0.6);
      animation: sparkFly 1.6s ease-out infinite;
      opacity: 0;
    }
    @keyframes sparkFly {
      0%   { transform: translate(0,0) scale(0.8); opacity: 0; }
      10%  { opacity: 1; }
      70%  { opacity: 1; }
      100% { transform: translate(var(--dx), var(--dy)) scale(0.2); opacity: 0; }
    }

    /* å¼€å§‹é¡µé¢ */
    .start-overlay {
      position: fixed;
      inset: 0;
      z-index: 970;
      background: radial-gradient(circle at top, rgba(33, 150, 243, 0.4), rgba(3, 7, 18, 0.95));
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.4s ease-out;
    }
    .start-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .start-card {
      width: 90%;
      max-width: 520px;
      background: rgba(9, 18, 32, 0.96);
      border-radius: 20px;
      border: 1px solid rgba(144, 202, 249, 0.9);
      box-shadow: 0 18px 45px rgba(0,0,0,0.75);
      padding: 18px 20px 16px;
      text-align: left;
    }
    .start-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .start-subtitle {
      font-size: 13px;
      opacity: 0.85;
      margin-bottom: 12px;
    }
    .start-desc {
      font-size: 13px;
      line-height: 1.7;
      opacity: 0.93;
      margin-bottom: 14px;
    }
    .start-button {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(255, 235, 130, 0.9);
      background: radial-gradient(circle at top, #ffe082, #ffb300);
      color: #222;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,0.6);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .start-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(0,0,0,0.7);
    }
    .start-button:active {
      transform: translateY(0);
      box-shadow: 0 8px 18px rgba(0,0,0,0.6);
    }
    .start-note {
      font-size: 11px;
      opacity: 0.78;
      text-align: right;
    }

    @media (max-width: 720px) {
      .game-content { padding: 14px 12px 12px; }
      .ui-panel-inner { padding: 10px; }
      .game-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .game-status { justify-content: flex-start; }
      .bottom-info { flex-direction: column; }
    }
/* ===== æ‰‹æœºç«¯é€‚é…ï¼šå®½åº¦ <= 600px æ—¶çš„è°ƒæ•´ ===== */
@media (max-width: 600px) {
  body {
    /* æ‰‹æœºä¸Šæ•´ä½“å­—å·ç¨å¾®æ”¾å¤§ä¸€ç‚¹ */
    font-size: 16px;
  }

  .game-wrapper {
    padding: 8px 0;
  }

  .game-card {
    /* æ‰‹æœºä¸Šé“ºæ»¡å±å¹•ï¼Œåœ†è§’å’Œé˜´å½±å¯ä»¥å¼±ä¸€ç‚¹ï¼Œæ²‰æµ¸æ„Ÿæ›´å¼º */
    width: 100%;
    max-width: 100%;
    border-radius: 0;
    box-shadow: none;
    border-left: none;
    border-right: none;
  }

  .game-content {
    padding: 14px 12px 12px;
    /* èƒŒæ™¯ç¨å¾®å†é€æ˜ä¸€ç‚¹ï¼Œæ–¹ä¾¿çœ‹è§èƒŒæ™¯å›¾ */
    background: linear-gradient(
      to bottom,
      rgba(7, 12, 24, 0.35),
      rgba(7, 12, 24, 0.7)
    );
  }

  .scene-text {
    min-height: 52vh;   /* æ–‡å­—åŒºåŸŸå å±å¹•é«˜åº¦å¤šä¸€ç‚¹ */
    max-height: none;   /* æ‰‹æœºä¸Šå…è®¸å¤šä¸€ç‚¹æ»šåŠ¨ */
    font-size: 15px;
  }

  .npc-dialogue-header {
    padding: 6px 8px;
    margin-bottom: 6px;
  }

  .npc-name {
    font-size: 14px;
  }

  .npc-role {
    font-size: 11px;
  }

  .choice-button {
    font-size: 14px;
    padding: 10px 10px;
  }

  .ui-toggle {
    left: 8px;
    top: 8px;
    padding: 4px 8px;
    font-size: 11px;
  }

  .achievements-toggle {
    right: 8px;
    bottom: 10px;
    padding: 6px 10px;
    font-size: 11px;
  }

  .start-card {
    padding: 16px 14px 14px;
  }

  .start-title {
    font-size: 18px;
  }

  .start-desc {
    font-size: 13px;
  }

  .start-button {
    font-size: 14px;
    padding: 10px 12px;
  }
}


  </style>
</head>
<body>
<div class="game-wrapper">
  <div class="game-card">
    <div class="game-bg" id="game-bg"></div>
    <div class="game-content">
      <div id="ending-effects" class="ending-effects"></div>
      <div id="npc-header-container"></div>
      <div id="scene-text" class="scene-text"></div>
      <div id="choice-list" class="choice-list"></div>
    </div>
  </div>
</div>

<!-- å¼€å§‹é¡µé¢ -->
<div id="start-overlay" class="start-overlay">
  <div class="start-card">
    <div class="start-title">ç±½å¥¥ä¸­å­¦ç½‘ç»œå®‰å…¨å†’é™©</div>
    <div class="start-subtitle">ç¬¬ 1 ç«  Â· æœºæˆ¿çš„å¥‡æ€ªä¸€å¤œ</div>
    <div class="start-desc">
      ä½ å°†èµ°è¿›ç±½å¥¥ä¸­å­¦çš„å¤œè‰²é‡Œï¼Œå’Œæ®·ç¼ºæ–¯æ±€ã€åˆ˜æ ¡é•¿ã€é‡‘åèŠ±è€å¸ˆä¸€èµ·ï¼Œé¢å¯¹ä¸€æ¬¡æ­£åœ¨â€œå‘èŠ½â€çš„ç½‘ç»œå®‰å…¨äº‹ä»¶ã€‚<br><br>
      æ¯ä¸€ä¸ªé€‰æ‹©ï¼Œéƒ½å¯èƒ½æ”¹å˜æ•…äº‹çš„èµ°å‘ï¼Œä¹Ÿä¼šè§£é”ä¸åŒçš„ç½‘ç»œå®‰å…¨ã€ŒçŸ¥è¯†ç‚¹æˆå°±ã€ã€‚
    </div>
    <button id="btn-start-game" class="start-button">
      <span>â–¶ ç‚¹å‡»è¿›å…¥æ ¡å›­</span>
      <span style="font-size:12px;opacity:0.85;">ï¼ˆå¼€å¯èƒŒæ™¯éŸ³ä¹ï¼‰</span>
    </button>
    <div class="start-note">å»ºè®®ä½©æˆ´è€³æœºä½“éªŒ Â· ç‚¹å‡»åèƒŒæ™¯éŸ³ä¹å°†æŒç»­æ’­æ”¾</div>
  </div>
</div>

<button id="ui-toggle" class="ui-toggle">
  <span>â˜°</span>
  <span>èœå•</span>
</button>

<div id="ui-panel" class="ui-panel">
  <div class="ui-panel-inner">
    <div class="ui-close-row">
      <button id="btn-close-ui" class="btn-close-ui">Ã—</button>
    </div>

    <div class="game-header">
      <div>
        <div class="game-title">ç±½å¥¥ä¸­å­¦ç½‘ç»œå®‰å…¨å†’é™©</div>
        <div class="game-subtitle">ç¬¬ 1 ç«  Â· æœºæˆ¿çš„å¥‡æ€ªä¸€å¤œ</div>
      </div>
      <div class="game-status">
        <button id="btn-music" class="music-toggle">
          <span id="music-icon">ğŸµ</span>
          <span id="music-label">éŸ³ä¹ï¼šå…³</span>
        </button>
        <div class="status-pill">
          <span class="status-label">èº«ä»½</span>
          <span class="status-value" id="status-role">æœªé€‰æ‹©</span>
        </div>
        <div class="status-pill">
          <span class="status-label">æ®·ç¼ºæ–¯æ±€ä¿¡ä»»</span>
          <span class="status-value" id="status-trust-yin">0</span>
        </div>
        <div class="status-pill">
          <span class="status-label">ç¬¬ 1 ç« è¿›åº¦</span>
          <span class="status-value" id="status-progress">0%</span>
        </div>
      </div>
    </div>

    <div class="bottom-info">
      <div class="sidebar-box">
        <div class="sidebar-section-title">å½“å‰åœºæ™¯ä¸»è¦ NPC</div>
        <ul class="sidebar-list" id="sidebar-npc"></ul>
      </div>
      <div class="sidebar-box">
        <div class="sidebar-section-title">æç¤º</div>
        <p id="sidebar-tip" style="margin:0; line-height:1.5;">
          ä»”ç»†çœ‹å¯¹è¯å’Œæè¿°ï¼Œä½ çš„é€‰æ‹©ä¼šä¸€ç‚¹ç‚¹æ”¹å˜åé¢çš„æ•…äº‹ã€‚
        </p>
      </div>
    </div>

    <div class="footer-hint">
      æç¤ºï¼šæ•…äº‹åŒºæ˜¯æ²‰æµ¸æ¨¡å¼ï¼Œè¿™é‡Œå¯ä»¥éšæ—¶æŸ¥çœ‹è¿›åº¦ã€NPC å’Œæç¤ºã€‚
    </div>
  </div>
</div>

<button id="btn-achievements" class="achievements-toggle">
  <span class="icon">â­</span>
  <span>æˆå°± / Achievements</span>
</button>

<div id="npc-detail-overlay" class="npc-detail-overlay" style="display:none;">
  <div class="npc-detail-card">
    <button class="npc-detail-close" aria-label="å…³é—­">Ã—</button>
    <div class="npc-detail-avatar" id="npc-detail-avatar"></div>
    <div class="npc-detail-main">
      <div class="npc-detail-name" id="npc-detail-name"></div>
      <div class="npc-detail-role" id="npc-detail-role"></div>
      <div class="npc-detail-desc" id="npc-detail-desc"></div>
      <div class="npc-detail-tags" id="npc-detail-tags"></div>
    </div>
  </div>
</div>

<div id="achievements-panel" class="achievements-panel">
  <div class="achievements-content">
    <div class="achievements-header">
      <div class="achievements-header-title">æˆå°±ä¸çŸ¥è¯†ç‚¹ Â· Achievements & Knowledge</div>
      <button id="btn-close-achievements" class="achievements-close-btn">Ã—</button>
    </div>
    <div id="achievements-list" class="achievements-list"></div>
  </div>
</div>

<!-- èƒŒæ™¯éŸ³ä¹ -->
<audio id="bgm-calm" src="audio/bgm_campus_night.mp3" loop preload="auto"></audio>
<audio id="bgm-tension" src="audio/bgm_lab_tension.mp3" loop preload="auto"></audio>
<audio id="bgm-office" src="audio/bgm_office_soft.mp3" loop preload="auto"></audio>

<!-- éŸ³æ•ˆ -->
<audio id="sfx-choice" src="audio/sfx_choice_click.mp3" preload="auto"></audio>
<audio id="sfx-achievement" src="audio/sfx_achievement_fanfare.mp3" preload="auto"></audio>
<audio id="sfx-typewriter" src="audio/sfx_typewriter_soft.mp3" preload="auto"></audio>

<script>
  // ==== NPC é…ç½® ====
  const npcProfiles = {
    "æ®·ç¼ºæ–¯æ±€": {
      role: "è®¡ç®—æœºç§‘å­¦è€å¸ˆ",
      initial: "æ®·",
      avatar: "img/npc_yin.png",
      desc: "è´Ÿè´£æœºæˆ¿ã€ä»£ç å’Œå„ç§â€œå¥‡æ€ªå®éªŒâ€ï¼Œå¯¹å­¦ç”Ÿé è°±ç¨‹åº¦æœ‰æ•é”é›·è¾¾ã€‚"
    },
    "çš‡å¤ªå­ï¼ˆçŒ«ï¼‰": {
      role: "ç±½å¥¥æ ¡å›­çŒ«",
      initial: "çŒ«",
      avatar: "img/npc_cat_prince.png",
      desc: "æ¯å¤©å·¡è§†æ•™å­¦æ¥¼ï¼Œå¯¹å¯ç–‘ U ç›˜å’Œæ™šå½’å­¦ç”Ÿæœ‰ç¬¬å…­æ„Ÿã€‚"
    },
    "åˆ˜æ ¡é•¿": {
      role: "ç±½å¥¥ä¸­å­¦æ ¡é•¿",
      initial: "åˆ˜",
      avatar: "img/npc_principal_liu.png",
      desc: "åœ¨â€œå®‰å…¨â€å’Œâ€œæ•™å­¦â€ä¹‹é—´æ‰¾å¹³è¡¡ï¼Œå…³é”®æ—¶åˆ»æ‹æ¿çš„äººã€‚"
    },
    "é‡‘åèŠ±è€å¸ˆ": {
      role: "IT éƒ¨é—¨ / æ ¡å›­ç½‘ç®¡ç†å‘˜",
      initial: "é‡‘",
      avatar: "img/npc_jin.png",
      desc: "æŒæ§ç½‘çº¿ã€äº¤æ¢æœºå’ŒæœåŠ¡å™¨å‘½è¿ï¼Œæ˜¯æ”»é˜²æˆ˜ä¸­çš„åç«¯å¤§è„‘ã€‚"
    }
  };
  const seenNPCs = new Set();

  // ==== çŸ¥è¯†ç‚¹ / æˆå°± ====
  const knowledgeData = {
    bait_usb: {
      zh: "è¯±é¥µæ”»å‡» / ä¸æ˜ U ç›˜é£é™©",
      en: "Baiting attack & unknown USB risks",
      desc: "æ¥è·¯ä¸æ˜çš„å­˜å‚¨è®¾å¤‡å¯èƒ½è—æœ‰æœ¨é©¬æˆ–å‹’ç´¢è½¯ä»¶ï¼Œåº”äº¤ç»™æœ‰å‡†å¤‡çš„ç¯å¢ƒåˆ†æï¼Œè€Œä¸æ˜¯ç›´æ¥æ’å…¥ç”Ÿäº§è®¾å¤‡ã€‚"
    },
    ransomware: {
      zh: "å‹’ç´¢è½¯ä»¶ Ransomware",
      en: "Ransomware",
      desc: "ä¸€ç§ä¼šåŠ å¯†æ–‡ä»¶å¹¶ç´¢è¦èµé‡‘çš„æ¶æ„è½¯ä»¶ã€‚é¢„é˜²å…³é”®åœ¨äºå¤‡ä»½ä¸é˜²æŠ¤ï¼Œé¿å…éšæ„è¿è¡ŒæœªçŸ¥ç¨‹åºã€‚"
    },
    sandbox: {
      zh: "æ²™ç®± / éš”ç¦»ç¯å¢ƒåˆ†æ",
      en: "Sandboxed / isolated analysis",
      desc: "åœ¨è™šæ‹Ÿæœºæˆ–éš”ç¦»ç¯å¢ƒä¸­è¿è¡Œå¯ç–‘ç¨‹åºï¼Œè§‚å¯Ÿå…¶è¡Œä¸ºï¼Œé¿å…æ±¡æŸ“çœŸå®ç³»ç»Ÿã€‚"
    },
    network_isolation: {
      zh: "ç½‘ç»œéš”ç¦» / é™åˆ¶ä¼ æ’­",
      en: "Network isolation & containment",
      desc: "åœ¨å‘ç°å…¥ä¾µæˆ–æ¶æ„è½¯ä»¶æ—¶ï¼Œå…ˆéš”ç¦»å—æ„ŸæŸ“åŒºåŸŸï¼Œé˜»æ­¢å¨èƒæ‰©æ•£ï¼Œå†è¿›è¡Œåˆ†æå’Œæ¸…ç†ã€‚"
    },
    live_monitoring: {
      zh: "å®æ—¶ç›‘æ§ä¸æº¯æº",
      en: "Live monitoring & trace-back",
      desc: "ä¿æŒç³»ç»Ÿè¿è¡Œï¼ŒåŒæ—¶å¯†åˆ‡ç›‘æ§æ—¥å¿—ä¸æµé‡ï¼Œä»¥ä¾¿æ”¶é›†æ”»å‡»è€…çº¿ç´¢å¹¶è¿›è¡Œæº¯æºï¼Œä½†ä¼´éšæ›´é«˜é£é™©ã€‚"
    }
  };

  // ==== æ¸¸æˆçŠ¶æ€ ====
  const state = {
    role: null,
    trustYin: 0,
    trustJin: 0,
    virusTriggered: false,
    reportedUsb: null,
    chapter1EndChoice: null,
    knowledge: new Set(),
    progress: 0
  };

 
function saveGameToLocal() {
  try {
    const data = {
      role: state.role || null,
      trustYin: state.trustYin || 0,
      trustJin: state.trustJin || 0,
      reportedUsb: state.reportedUsb || null,
      chapter1EndChoice: state.chapter1EndChoice || null,
      progress: state.progress || 0,
      knowledge: Array.from(state.knowledge || [])
    };
    localStorage.setItem("zaoCyberGameSave", JSON.stringify(data));
    console.log("å·²å†™å…¥æœ¬åœ°å­˜æ¡£ï¼š", data);
  } catch (e) {
    console.warn("å†™å…¥æœ¬åœ°å­˜æ¡£å¤±è´¥ï¼š", e);
  }
}



  function setProgress(p) {
    if (p > state.progress) state.progress = Math.min(100, p);
    document.getElementById("status-progress").textContent = state.progress + "%";
  }

  function updateStatusBar() {
    const roleText =
      state.role === "student" ? "å­¦ç”Ÿ" :
      state.role === "teacher" ? "è€å¸ˆ" :
      state.role === "principal" ? "æ ¡é•¿" : "æœªé€‰æ‹©";
    document.getElementById("status-role").textContent = roleText;
    document.getElementById("status-trust-yin").textContent = state.trustYin;
    document.getElementById("status-progress").textContent = state.progress + "%";
  }

  function renderSidebarNpc(npcList) {
    const ul = document.getElementById("sidebar-npc");
    ul.innerHTML = "";
    if (!npcList || npcList.length === 0) {
      const li = document.createElement("li");
      li.textContent = "æš‚æ— å…³é”® NPCã€‚";
      ul.appendChild(li);
      return;
    }
    npcList.forEach(name => {
      const li = document.createElement("li");
      li.innerHTML = '<span class="npc-tag">' + name + '</span>';
      ul.appendChild(li);
    });
  }

  function setSidebarTip(text) {
    document.getElementById("sidebar-tip").textContent = text;
  }

  // ==== éŸ³ä¹ & éŸ³æ•ˆ ====
  const bgmTracks = {
    calm: document.getElementById("bgm-calm"),
    tension: document.getElementById("bgm-tension"),
    office: document.getElementById("bgm-office")
  };
  const sfxChoiceEl = document.getElementById("sfx-choice");
  const sfxAchievementEl = document.getElementById("sfx-achievement");
  const sfxTypeEl = document.getElementById("sfx-typewriter");

let typingSoundKey = null;

function startTypingSound(ownerKey) {
  if (!sfxTypeEl) return;
  // å¦‚æœå·²ç»åœ¨ä¸ºåŒä¸€ä¸ªé¡µé¢/é€‰é¡¹æ’­æ”¾ï¼Œå°±ä¸é‡å¤å¼€
  if (typingSoundKey === ownerKey) return;
  typingSoundKey = ownerKey;
  try {
    sfxTypeEl.loop = true;
    sfxTypeEl.currentTime = 0;
    sfxTypeEl.play().catch(() => {});
  } catch (e) {}
}

function stopTypingSound(ownerKey) {
  if (!sfxTypeEl) return;
  // å¦‚æœä¼ å…¥ keyï¼Œä¸æ˜¯å½“å‰çš„ï¼Œå°±ä¸è¦è¯¯åœ
  if (ownerKey && ownerKey !== typingSoundKey) return;
  typingSoundKey = null;
  try {
    sfxTypeEl.pause();
    sfxTypeEl.loop = false;
    sfxTypeEl.currentTime = 0;
  } catch (e) {}
  // æ‰“å­—æœºå£°åœæ‰åï¼Œæ¢å¤ BGM
  ensureBgmResumes();
}


  const btnMusic = document.getElementById("btn-music");
  const musicLabel = document.getElementById("music-label");
  const musicIcon = document.getElementById("music-icon");

  let musicEnabled = false;
  let currentBgmKey = null;
  let typeTickCounter = 0;

  function stopAllBgm() {
    Object.values(bgmTracks).forEach(el => {
      if (el) el.pause();
    });
  }

  function ensureBgmResumes() {
    if (!musicEnabled || !currentBgmKey) return;
    const track = bgmTracks[currentBgmKey];
    if (track && track.paused) {
      track.play().catch(() => {});
    }
  }

  function updateBgmForScene(scene) {
    const key = scene.bgm || "calm";
    currentBgmKey = currentBgmKey || key;

    if (!musicEnabled) {
      currentBgmKey = key;
      return;
    }

    if (currentBgmKey === key) {
      const track = bgmTracks[key];
      if (track && track.paused) {
        track.play().catch(() => {});
      }
      return;
    }

    const oldTrack = bgmTracks[currentBgmKey];
    if (oldTrack) oldTrack.pause();

    const newTrack = bgmTracks[key];
    if (newTrack) {
      newTrack.currentTime = 0;
      newTrack.play().catch(() => {});
    }
    currentBgmKey = key;
  }

  btnMusic.addEventListener("click", () => {
    musicEnabled = !musicEnabled;
    if (!musicEnabled) {
      stopAllBgm();
      musicLabel.textContent = "éŸ³ä¹ï¼šå…³";
      musicIcon.textContent = "ğŸµ";
    } else {
      musicLabel.textContent = "éŸ³ä¹ï¼šå¼€";
      musicIcon.textContent = "ğŸ”Š";
      const scene = scenes[currentSceneId];
      if (scene) updateBgmForScene(scene);
    }
  });

  function playSfx(type) {
    try {
      if (type === "choice" && sfxChoiceEl) {
        sfxChoiceEl.currentTime = 0;
        sfxChoiceEl.play().catch(() => {});
      } else if (type === "achievement" && sfxAchievementEl) {
        sfxAchievementEl.currentTime = 0;
        sfxAchievementEl.play().catch(() => {});
      }
    } catch (e) {}
  }

  function playTypeTick() {
    if (!sfxTypeEl) return;
    typeTickCounter++;
    if (typeTickCounter % 3 !== 0) return;
    try {
      sfxTypeEl.currentTime = 0;
      sfxTypeEl.play().catch(() => {});
    } catch (e) {}
  }

  [sfxChoiceEl, sfxAchievementEl, sfxTypeEl].forEach(el => {
    if (!el) return;
    el.addEventListener("ended", () => {
      ensureBgmResumes();
    });
  });

  // ==== èƒŒæ™¯å›¾ç‰‡ï¼šé¢„åŠ è½½ + åˆ‡æ¢ ====
  function setBackgroundImage(url) {
  const bgEl = document.getElementById("game-bg");
  if (!bgEl) return;

  if (!url) {
    bgEl.style.backgroundImage =
      "radial-gradient(circle at top, #263238, #000000)";
    return;
  }

  const img = new Image();
  img.onload = () => {
    console.log("èƒŒæ™¯å›¾åŠ è½½æˆåŠŸ:", url);
    bgEl.style.backgroundImage = `url("${url}")`;
  };
  img.onerror = () => {
    console.warn("èƒŒæ™¯å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥è·¯å¾„/æ–‡ä»¶åï¼š", url);
    bgEl.style.backgroundImage =
      "radial-gradient(circle at top, #37474f, #000000)";
  };
  img.src = url;
}


  // ==== æˆå°±ç‰¹æ•ˆ ====
  function showAchievementFlash(id) {
    const info = knowledgeData[id] || { zh: id, en: "", desc: "" };
    const overlay = document.createElement("div");
    overlay.className = "achievement-flash-overlay";

    const card = document.createElement("div");
    card.className = "achievement-flash-card";
    card.innerHTML = `
      <div class="achievement-flash-title">æ–°çŸ¥è¯†ç‚¹è§£é” Â· New knowledge</div>
      <div class="achievement-flash-name">${info.zh}</div>
      <div class="achievement-flash-name-en">${info.en}</div>
      ${info.desc ? `<div class="achievement-flash-desc">${info.desc}</div>` : ""}
      <div class="achievement-flash-footer">å·²åŠ å…¥æˆå°±åˆ—è¡¨ Â· Added to achievements</div>
    `;
    overlay.appendChild(card);
    document.body.appendChild(overlay);

    playSfx("achievement");

    setTimeout(() => {
      const btn = document.getElementById("btn-achievements");
      if (!btn) {
        card.style.opacity = "0";
        setTimeout(() => overlay.remove(), 500);
        return;
      }
      const cardRect = card.getBoundingClientRect();
      const btnRect = btn.getBoundingClientRect();
      const dx = (btnRect.left + btnRect.width / 2) - (cardRect.left + cardRect.width / 2);
      const dy = (btnRect.top + btnRect.height / 2) - (cardRect.top + cardRect.height / 2);

      card.style.transform = `translate(${dx}px, ${dy}px) scale(0.2)`;
      card.style.opacity = "0";

      setTimeout(() => {
        overlay.remove();
        btn.classList.add("pulse");
        setTimeout(() => btn.classList.remove("pulse"), 800);
      }, 520);
    }, 2000);
  }

  function renderAchievementsPanel() {
    const listEl = document.getElementById("achievements-list");
    listEl.innerHTML = "";
    if (state.knowledge.size === 0) {
      const p = document.createElement("p");
      p.textContent = "ä½ è¿˜æ²¡æœ‰è§£é”ä»»ä½•çŸ¥è¯†ç‚¹ã€‚å¤šç•™æ„é‚£äº›å¯ç–‘çš„ç»†èŠ‚å’Œè€å¸ˆçš„è®²è§£ã€‚";
      listEl.appendChild(p);
      return;
    }
    Array.from(state.knowledge).forEach(id => {
      const info = knowledgeData[id] || { zh: id, en: "", desc: "" };
      const div = document.createElement("div");
      div.className = "achievement-item";
      div.innerHTML = `
        <div class="achievement-name-zh">${info.zh}</div>
        <div class="achievement-name-en">${info.en}</div>
        ${info.desc ? `<div class="achievement-desc">${info.desc}</div>` : ""}
      `;
      listEl.appendChild(div);
    });
  }

  function addKnowledge(id) {
    if (!knowledgeData[id]) {
      if (!state.knowledge.has(id)) state.knowledge.add(id);
      return;
    }
    const isNew = !state.knowledge.has(id);
    state.knowledge.add(id);
    if (isNew) {
      showAchievementFlash(id);
      const panel = document.getElementById("achievements-panel");
      if (panel.classList.contains("active")) {
        renderAchievementsPanel();
      }
    }
  }

  // ==== NPC æ–°è§’è‰²ç™»åœºç‰¹æ•ˆ ====
  function showNpcIntroSequence(names, callback) {
    if (!names || names.length === 0) {
      if (callback) callback();
      return;
    }
    let idx = 0;
    function showNext() {
      if (idx >= names.length) {
        if (callback) callback();
        return;
      }
      const name = names[idx++];
      const profile = npcProfiles[name] || { role: "ç¥ç§˜ NPC", initial: "?", avatar: null, desc: "" };

      const overlay = document.createElement("div");
      overlay.className = "npc-intro-overlay";

      const card = document.createElement("div");
      card.className = "npc-intro-card";

      const avatar = document.createElement("div");
      avatar.className = "npc-intro-avatar";
      if (profile.avatar) {
        const img = document.createElement("img");
        img.src = profile.avatar;
        img.alt = name;
        avatar.appendChild(img);
      } else {
        avatar.textContent = profile.initial || "?";
      }

      const main = document.createElement("div");
      main.className = "npc-intro-main";
      main.innerHTML = `
        <div class="npc-intro-tag">æ–°è§’è‰²ç™»åœº Â· New character</div>
        <div class="npc-intro-name">${name}</div>
        <div class="npc-intro-role">${profile.role || ""}</div>
        ${profile.desc ? `<div class="npc-intro-desc">${profile.desc}</div>` : ""}
      `;

      card.appendChild(avatar);
      card.appendChild(main);
      overlay.appendChild(card);
      document.body.appendChild(overlay);

      requestAnimationFrame(() => {
        card.classList.add("active");
      });

      setTimeout(() => {
        card.classList.remove("active");
        card.style.opacity = "0";
        setTimeout(() => {
          overlay.remove();
          setTimeout(showNext, 200);
        }, 350);
      }, 2200);
    }
    showNext();
  }

  // ==== NPC è¯¦æƒ…ï¼ˆç‚¹å‡»å¤´åƒï¼‰ ====
  function showNpcDetail(name) {
    const overlay = document.getElementById("npc-detail-overlay");
    const avatarEl = document.getElementById("npc-detail-avatar");
    const nameEl = document.getElementById("npc-detail-name");
    const roleEl = document.getElementById("npc-detail-role");
    const descEl = document.getElementById("npc-detail-desc");
    const tagsEl = document.getElementById("npc-detail-tags");
    if (!overlay || !avatarEl || !nameEl || !roleEl || !descEl || !tagsEl) return;

    const profile = npcProfiles[name] || { role: "ç¥ç§˜ NPC", initial: "?", avatar: null, desc: "" };
    avatarEl.innerHTML = "";
    if (profile.avatar) {
      const img = document.createElement("img");
      img.src = profile.avatar;
      img.alt = name;
      avatarEl.appendChild(img);
    } else {
      avatarEl.textContent = profile.initial || "?";
    }

    nameEl.textContent = name;
    roleEl.textContent = profile.role || "";
    descEl.textContent = profile.desc || "å°šæœªäº†è§£è¿™ä½è§’è‰²çš„æ›´å¤šç»†èŠ‚ã€‚";

    const trustTag =
      name === "æ®·ç¼ºæ–¯æ±€"
        ? `ä¿¡ä»»å€¼ ${state.trustYin ?? 0}`
        : name === "é‡‘åèŠ±è€å¸ˆ"
        ? `ä¿¡ä»»å€¼ ${state.trustJin ?? 0}`
        : "ä¿¡ä»»å€¼ å¾…å»ºç«‹";

    const seenTag = seenNPCs.has(name) ? "å·²å‡ºåœº" : "æœªå‡ºåœº";
    tagsEl.innerHTML = "";
    [trustTag, seenTag].forEach(text => {
      const t = document.createElement("div");
      t.className = "npc-detail-tag";
      t.textContent = text;
      tagsEl.appendChild(t);
    });

    overlay.style.display = "flex";
  }

function hideNpcDetail() {
  const overlay = document.getElementById("npc-detail-overlay");
  if (overlay) overlay.style.display = "none";
}

// ==== ç»“å±€ç‰¹æ•ˆ ====
const endingEffects = document.getElementById("ending-effects");
function resetEndingEffects() {
  if (!endingEffects) return;
  endingEffects.className = "ending-effects";
  endingEffects.innerHTML = "";
}
function showEndingEffects(key) {
  resetEndingEffects();
  if (!endingEffects || !key) return;
  if (key === "good") {
    endingEffects.classList.add("ending-good");
    const count = 14;
    const frag = document.createDocumentFragment();
    for (let i = 0; i < count; i++) {
      const s = document.createElement("div");
      s.className = "spark";
      const dx = (Math.random() * 2 - 1) * 220;
      const dy = -Math.random() * 220 - 60;
      const delay = Math.random() * 0.8;
      const size = Math.random() * 6 + 4;
      s.style.setProperty("--dx", `${dx}px`);
      s.style.setProperty("--dy", `${dy}px`);
      s.style.width = `${size}px`;
      s.style.height = `${size}px`;
      s.style.left = `${Math.random() * 100}%`;
      s.style.top = `${60 + Math.random() * 30}%`;
      s.style.animationDelay = `${delay}s`;
      frag.appendChild(s);
    }
    endingEffects.appendChild(frag);
  } else if (key && key.startsWith("bad")) {
    endingEffects.classList.add("ending-bad");
  }
}

  // ==== æ‰“å­—æœº ====
  let currentSceneId = "scene_title";
  let currentPages = [];
  let currentPageIndex = 0;

  function typeWriter(html, container, key, onComplete) {
  let i = 0;
  container.innerHTML = "";

  // å¼€å§‹æ•´æ®µæ‰“å­—æœºå£°éŸ³
  startTypingSound(key);

  function step() {
    // å¦‚æœé¡µé¢å·²ç»åˆ‡èµ°äº†ï¼Œç«‹åˆ»åœå£°éŸ³å¹¶ç»ˆæ­¢
    if (currentSceneId + "_p" + currentPageIndex !== key) {
      stopTypingSound(key);
      return;
    }

    if (i >= html.length) {
      container.innerHTML = html;
      container.classList.add("typing-caret");
      // æ‰“å®Œï¼Œåœæ‰“å­—æœºå£°éŸ³
      stopTypingSound(key);
      if (typeof onComplete === "function") onComplete();
      return;
    }

    const ch = html[i];
    if (ch === "<") {
      const j = html.indexOf(">", i);
      if (j === -1) {
        i++;
      } else {
        i = j + 1;
      }
    } else {
      i++;
    }

    container.innerHTML = html.slice(0, i);
    container.classList.remove("typing-caret");

    setTimeout(step, 18);
  }

  step();
}

function typeChoiceLabel(text, element, key, callback) {
  let i = 0;
  element.textContent = "";

  // é€‰é¡¹å¼€å§‹æ‰“å­—ï¼Œä¹Ÿå¼€ä¸€å°æ®µæ‰“å­—æœºå£°
  startTypingSound(key);

  function step() {
    if (i > text.length) {
      element.textContent = text;
      // æ‰“å®Œé€‰é¡¹ï¼Œåœæ‰“å­—æœºå£°éŸ³
      stopTypingSound(key);
      if (callback) callback();
      return;
    }
    element.textContent = text.slice(0, i);
    i++;
    setTimeout(step, 16);
  }

  step();
}



  function paginateText(html) {
    const chunks = html.split(/<\/p>/i);
    const paras = [];
    chunks.forEach(c => {
      const trimmed = c.trim();
      if (trimmed) paras.push(trimmed + "</p>");
    });
    if (paras.length === 0) return [html];

    const PAGE_SIZE = 4;
    const pages = [];
    for (let i = 0; i < paras.length; i += PAGE_SIZE) {
      const pageHtml = paras.slice(i, i + PAGE_SIZE).join("");
      pages.push(pageHtml);
    }
    return pages;
  }

  // ==== åœºæ™¯å®šä¹‰ ====
  const scenes = {
    "scene_title": {
      id: "scene_title",
      speaker: null,
      npcs: [],
      bg: "img/bg_campus_evening.jpg",
      bgm: "calm",
      text: function () {
        return `
<p style="font-size:17px;font-weight:600;margin-bottom:4px;">ç±½å¥¥ä¸­å­¦ Â· å‚æ™š</p>
<p>æ®è¯´æœ€è¿‘ï¼Œç±½å¥¥ä¸­å­¦çš„æ ¡å›­ç½‘æœ‰ç‚¹ä¸å¤ªå¯¹åŠ²ï¼š</p>
<p>æœ‰äººè¯´ä¸Šè¯¾æŠ•å±çªç„¶é»‘å±ï¼Œæœ‰äººè¯´é‚®ç®±æ”¶åˆ°äº†å¥‡æ€ªçš„è·å¥–é€šçŸ¥ï¼Œè¿˜æœ‰äººè¯´æœºæˆ¿ç”µè„‘ä¼šâ€œè‡ªå·±åŠ¨â€ã€‚</p>
<p>ç›®å‰ï¼Œè¿™äº›äº‹éƒ½åªè¢«å½“æˆâ€œæ ¡å›­æµè¨€â€â€”â€”ç›´åˆ°ä»Šå¤©å‚æ™šï¼Œä½ èµ°åˆ°äº†æœºæˆ¿é—¨å£ã€‚</p>
<p class="aside">ï¼ˆæœ¬ç« ä½ å°†ä»¥ <span class="highlight">å­¦ç”Ÿ</span> èº«ä»½ä½“éªŒæ•…äº‹ã€‚è€å¸ˆ / æ ¡é•¿è§†è§’å¯ä»¥åœ¨åé¢ç« èŠ‚æ‰©å±•ã€‚ï¼‰</p>
        `;
      },
      choices: [
        {
          text: "ä»¥å­¦ç”Ÿèº«ä»½å¼€å§‹ Â· èµ°å‘æœºæˆ¿",
          hint: "è¿›å…¥ç¬¬ 1 ç« ï¼šæœºæˆ¿çš„å¥‡æ€ªä¸€å¤œ",
          next: "scene_corridor",
          effect: function (s) {
            s.role = "student";
            setProgress(10);
          }
        }
      ],
      tip: "è¿™ä¸€ç« ä¼šå†³å®šåç»­å¤§è·¯çº¿çš„åˆ†æ”¯ï¼Œè¯·ç•™æ„ä½ å¯¹ U ç›˜å’Œç½‘ç»œç­–ç•¥çš„é€‰æ‹©ã€‚"
    },

    "scene_corridor": {
      id: "scene_corridor",
      speaker: "æ®·ç¼ºæ–¯æ±€",
      npcs: ["æ®·ç¼ºæ–¯æ±€", "çš‡å¤ªå­ï¼ˆçŒ«ï¼‰"],
      bg: "img/bg_corridor_evening.jpg",
      bgm: "calm",
      text: function () {
        return `
<p>æ•™å­¦æ¥¼èµ°å»Šæœ‰ç‚¹å®‰é™ï¼Œåªå‰©ä¸‹å‡ é—´æ•™å®¤è¿˜äº®ç€ç¯ã€‚</p>
<p>æœºæˆ¿é—¨åŠæ©ç€ï¼Œä¸€åªæ©˜ç™½ç›¸é—´çš„çŒ«è¶´åœ¨é—¨å£çš„åœ°å«ä¸Šæ‰“ç›¹â€”â€”é‚£æ˜¯ç±½å¥¥çš„çŒ«ï¼Œå¤§å®¶éƒ½å«å®ƒ <span class="highlight">çš‡å¤ªå­</span>ã€‚</p>
<p class="npc">æ®·ç¼ºæ–¯æ±€ï¼š</p>
<p>â€œå“Ÿï¼Œä½ æ¥çš„æ­£å¥½ã€‚æœ€åä¸€èŠ‚æœºæˆ¿è¯¾ï¼Œé¡ºä¾¿åšä¸ªå°å°çš„å®‰å…¨ç»ƒä¹ ã€‚â€</p>
<p>ä»–æŠ¬å¤´çœ‹äº†ä½ ä¸€çœ¼ï¼Œåˆçœ‹äº†çœ‹æ‰‹æœºä¸Šè·³åŠ¨çš„ç³»ç»Ÿæ—¥å¿—ã€‚</p>
<p class="npc">æ®·ç¼ºæ–¯æ±€ï¼š</p>
<p>â€œå¬è¯´ä½ å¯¹ç”µè„‘æŒºæ„Ÿå…´è¶£ï¼Ÿæ˜¯ä»€ä¹ˆç±»å‹çš„â€˜æ„Ÿå…´è¶£â€™ï¼Ÿâ€</p>
        `;
      },
      choices: [
        {
          text: "â€œä¸»è¦å¯¹æ¸¸æˆæ„Ÿå…´è¶£ã€‚â€",
          hint: "æ™®é€šå›ç­”",
          next: "scene_quiz_intro",
          effect: function (s) {
            s.trustYin += 3;
            setProgress(20);
          }
        },
        {
          text: "â€œå¯¹ç½‘ç»œå®‰å…¨æ›´æ„Ÿå…´è¶£ä¸€ç‚¹ã€‚â€",
          hint: "æŠ€æœ¯å‘ +1",
          next: "scene_quiz_intro",
          effect: function (s) {
            s.trustYin += 10;
            setProgress(20);
          }
        },
        {
          text: "â€œæˆ‘åªæ˜¯æƒ³æ¥è¹­ç©ºè°ƒã€‚â€",
          hint: "ä¸€æœ¬æ­£ç»åœ°èƒ¡è¯´å…«é“",
          next: "scene_quiz_intro",
          effect: function (s) {
            s.trustYin += 3;
            setProgress(20);
          }
        }
      ],
      tip: "æ®·ç¼ºæ–¯æ±€æ˜¯ä½ åé¢æœ€é‡è¦çš„æŠ€æœ¯é˜Ÿå‹ï¼Œä»–å¯¹ä½ â€œé ä¸é è°±â€çš„å°è±¡ä¼šå½±å“æ„¿æ„å‘Šè¯‰ä½ å¤šå°‘ä¸œè¥¿ã€‚"
    },

    "scene_quiz_intro": {
      id: "scene_quiz_intro",
      speaker: "æ®·ç¼ºæ–¯æ±€",
      npcs: ["æ®·ç¼ºæ–¯æ±€"],
      bg: "img/bg_lab_evening.jpg",
      bgm: "calm",
      text: function () {
        return `
<p>ä½ è·Ÿç€æ®·ç¼ºæ–¯æ±€èµ°è¿›æœºæˆ¿ï¼Œä¸€æ’æ’ç”µè„‘å®‰é™åœ°äº®ç€å±å¹•ã€‚</p>
<p class="npc">æ®·ç¼ºæ–¯æ±€ï¼š</p>
<p>â€œæ­£å¼ä¸Šè¯¾å‰ï¼Œå…ˆæ¥å‡ ä¸ª<span class="highlight">çµé­‚å°é—®é¢˜</span>ï¼Œæµ‹æµ‹ä½ çš„å®‰å…¨ç›´è§‰ã€‚â€</p>
<p class="aside">ï¼ˆæ¥ä¸‹æ¥çš„é€‰æ‹©ä¸ä¼šå½“åœºåˆ¤ä½ æ­»åˆ‘ï¼Œä½†ä¼šå½±å“ä»–å¯¹ä½ â€œé ä¸é è°±â€çš„è¯„ä»·ã€‚ï¼‰</p>
        `;
      },
      choices: [
        {
          text: "åšå¥½å¿ƒç†å‡†å¤‡ï¼Œå¼€å§‹å°æµ‹ã€‚",
          hint: "è¿›å…¥å°æµ‹",
          next: "scene_quiz_q1",
          effect: function () {
            setProgress(30);
          }
        }
      ],
      tip: "å°æµ‹åªæ˜¯é“ºå«ï¼ŒçœŸæ­£çš„å±é™©åœ¨åé¢â€”â€”ä½†ä½ ç°åœ¨ç»™å‡ºçš„ç­”æ¡ˆï¼Œä¼šåœ¨ä»–å¿ƒé‡Œæ‰“ä¸ªè‰ç¨¿ã€‚"
    },

    "scene_quiz_q1": {
      id: "scene_quiz_q1",
      speaker: "æ®·ç¼ºæ–¯æ±€",
      npcs: ["æ®·ç¼ºæ–¯æ±€"],
      bg: "img/bg_lab_evening.jpg",
      bgm: "calm",
      text: function () {
        return `
<p class="npc">æ®·ç¼ºæ–¯æ±€ï¼š</p>
<p>â€œç¬¬ä¸€ä¸ªé—®é¢˜â€”â€”ä¸‹é¢å“ªä¸ªå¯†ç æœ€<span class="highlight">å±é™©</span>ï¼Ÿâ€</p>
<p>A. <code>123456</code></p>
<p>B. <code>ILoveZaoHigh2025!</code></p>
<p>C. <code>Z!Ao_3CStu</code></p>
        `;
      },
      choices: [
        {
          text: "é€‰ Aï¼š123456",
          hint: "å¸¸è§å¼±å¯†ç ",
          next: "scene_quiz_q2",
          effect: function (s) {
            alert("æ®·ç¼ºæ–¯æ±€ï¼š\nâ€œå¯¹ï¼Œæœ€å…¸å‹çš„å¼±å¯†ç ã€‚æ’åº“çš„äººéƒ½å…ˆè¯•è¿™ä¸ªã€‚â€");
            s.trustYin += 6;
          }
        },
        {
          text: "é€‰ Bï¼šILoveZaoHigh2025!",
          hint: "çœ‹èµ·æ¥æŒºå¤æ‚",
          next: "scene_quiz_q2",
          effect: function (s) {
            alert("æ®·ç¼ºæ–¯æ±€ï¼š\nâ€œå‹‰å¼ºç®—è¿˜å¯ä»¥çš„å¯†ç ï¼Œæ¯” 123456 å¥½å¤šäº†ã€‚â€");
            s.trustYin += 2;
          }
        },
        {
          text: "é€‰ Cï¼šZ!Ao_3CStu",
          hint: "å¾ˆéš¾è®°",
          next: "scene_quiz_q2",
          effect: function (s) {
            alert("æ®·ç¼ºæ–¯æ±€ï¼š\nâ€œå¤æ‚ä¸ä»£è¡¨å¸¸è§ï¼ŒçœŸæ­£å±é™©çš„æ˜¯å¤§å®¶éƒ½åœ¨ç”¨çš„é‚£ç§ã€‚â€");
            s.trustYin += 0;
          }
        }
      ],
      tip: "å¼±å¯†ç æ˜¯æš´åŠ›ç ´è§£å’Œæ’åº“æ”»å‡»çš„å¥½æœ‹å‹â€”â€”åˆ«æŠŠä½ çš„å¯†ç é€åˆ°ä»–ä»¬å˜´è¾¹ã€‚"
    },

    "scene_quiz_q2": {
      id: "scene_quiz_q2",
      speaker: "æ®·ç¼ºæ–¯æ±€",
      npcs: ["æ®·ç¼ºæ–¯æ±€"],
      bg: "img/bg_lab_evening.jpg",
      bgm: "calm",
      text: function () {
        return `
<p class="npc">æ®·ç¼ºæ–¯æ±€ï¼š</p>
<p>â€œç¬¬äºŒä¸ªé—®é¢˜â€”â€”æœ‰äººç»™ä½ ä¸€ä¸ªæ¥è·¯ä¸æ˜çš„ U ç›˜ï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿâ€</p>
<p>A. ç«‹åˆ»æ’ä¸Šçœ‹çœ‹é‡Œé¢æœ‰ä»€ä¹ˆã€‚</p>
<p>B. å…ˆé—®é—®æ˜¯è°çš„ï¼Œæˆ–è€…äº¤ç»™è€å¸ˆå¤„ç†ã€‚</p>
<p>C. æ”¶è¿›æŠ½å±‰ï¼Œä»¥åæœ‰ç©ºå†çœ‹ã€‚</p>
        `;
      },
      choices: [
        {
          text: "A. ç«‹åˆ»æ’ä¸Šçœ‹çœ‹ã€‚",
          hint: "å¥½å¥‡å®³æ­»çŒ«ï¼ˆå¯èƒ½ä¹Ÿå®³ç”µè„‘ï¼‰",
          next: "scene_quiz_after",
          effect: function (s) {
            alert("æ®·ç¼ºæ–¯æ±€ï¼š\nâ€œè¿™ç§å«â€˜è¯±é¥µâ€™ï¼Œå¾ˆå¤šæœ¨é©¬ã€å‹’ç´¢è½¯ä»¶å°±é å®ƒè¿›æ¥ã€‚â€");
            addKnowledge("bait_usb");
            s.trustYin -= 2;
            setProgress(35);
          }
        },
        {
          text: "B. ä¸Šäº¤è€å¸ˆ / é—®æ¸…æ¥å†ã€‚",
          hint: "å®‰å…¨æ„è¯† +1",
          next: "scene_quiz_after",
          effect: function (s) {
            alert("æ®·ç¼ºæ–¯æ±€ï¼š\nâ€œä¸é”™ï¼Œä¸è®¤è¯†çš„ä¸œè¥¿äº¤ç»™æ›´ä¸“ä¸šçš„äººçœ‹ï¼Œæ˜¯æ¯”è¾ƒç¨³çš„åšæ³•ã€‚â€");
            addKnowledge("bait_usb");
            s.trustYin += 6;
            setProgress(35);
          }
        },
        {
          text: "C. å…ˆæ”¾ç€ï¼Œæ”¹å¤©å†è¯´ã€‚",
          hint: "æ‹–å»¶=æ”¾ç€éšæ‚£ä¸ç®¡",
          next: "scene_quiz_after",
          effect: function (s) {
            alert("æ®·ç¼ºæ–¯æ±€ï¼š\nâ€œæ‹–å»¶ä¹Ÿç®—ä¸€ç§å†³ç­–â€”â€”æ˜¯æŠŠå®šæ—¶ç‚¸å¼¹ç•™åœ¨æ¡Œä¸Šã€‚â€");
            addKnowledge("bait_usb");
            s.trustYin += 0;
            setProgress(35);
          }
        }
      ],
      tip: "ä¸æ˜å­˜å‚¨è®¾å¤‡ = æ½œåœ¨çš„æ¶æ„è½½ä½“ï¼Œæœ€å®‰å…¨çš„åšæ³•æ˜¯äº¤ç»™æœ‰å‡†å¤‡çš„ç¯å¢ƒå»åˆ†æã€‚"
    },

    "scene_quiz_after": {
      id: "scene_quiz_after",
      speaker: null,
      npcs: ["æ®·ç¼ºæ–¯æ±€"],
      bg: "img/bg_lab_evening.jpg",
      bgm: "calm",
      text: function () {
        return `
<p>å‡ é“å°é¢˜åšå®Œï¼Œæœºæˆ¿é‡Œé€æ¸å®‰é™ä¸‹æ¥ï¼Œå…¶ä»–åŒå­¦é™†ç»­å…³æœºç¦»å¼€ã€‚</p>
<p class="npc">æ®·ç¼ºæ–¯æ±€ï¼š</p>
<p>â€œå¥½äº†ï¼Œä»Šå¤©çš„ mini-quiz å°±åˆ°è¿™ã€‚è®°ä½ä¸€å¥è¯ï¼š<span class="highlight">å¥½å¥‡ + æ–¹ä¾¿ + å¤§æ„</span>ï¼Œæ˜¯é»‘å®¢æœ€çˆ±çš„ä¸‰ä»¶å¥—ã€‚â€</p>
<p>ä½ å¼€å§‹æ•´ç†è‡ªå·±çš„ä¹¦åŒ…ï¼Œå‡†å¤‡ç¦»å¼€æœºæˆ¿ã€‚</p>
<p>å°±åœ¨è¿™æ—¶ï¼Œä½ åœ¨ç¬¬ 12 å·ç”µè„‘æ—è¾¹ï¼Œçœ‹åˆ°äº†ä¸€æ ·ä¸œè¥¿â€”â€”</p>
        `;
      },
      choices: [
        {
          text: "èµ°è¿‘ç¬¬ 12 å·ç”µè„‘çœ‹çœ‹ã€‚",
          hint: "è§¦å‘å…³é”®äº‹ä»¶",
          next: "scene_usb_choice",
          effect: function () {
            setProgress(45);
          }
        }
      ],
      tip: "åˆšåˆšè¯¾å ‚æåˆ°çš„ U ç›˜æƒ…æ™¯ï¼Œé©¬ä¸Šå°±è¦åœ¨ç°å®ä¸Šæ¼”äº†ã€‚"
    },

    "scene_usb_choice": {
      id: "scene_usb_choice",
      speaker: "æ®·ç¼ºæ–¯æ±€",
      npcs: ["æ®·ç¼ºæ–¯æ±€", "çš‡å¤ªå­ï¼ˆçŒ«ï¼‰"],
      bg: "img/bg_lab_evening.jpg",
      bgm: "calm",
      text: function () {
        return `
<p>ç¬¬ 12 å·ç”µè„‘æ—è¾¹çš„æ¡Œé¢ä¸Šï¼Œé™é™èººç€ä¸€ä¸ªé“¶è‰² U ç›˜ã€‚</p>
<p>ä¸Šé¢ç”¨é»‘è‰²æ²¹ç¬”å†™ç€ä¸‰ä¸ªå­—ï¼š</p>
<p style="text-align:center;margin-top:4px;margin-bottom:4px;"><span class="highlight">â€œåˆ«æ‰“å¼€â€</span></p>
<p class="aside">çš‡å¤ªå­æ™ƒæ‚ ç€å°¾å·´ï¼Œä»é—¨å£ç»è¿‡ï¼Œå–µäº†ä¸€å£°ï¼Œä»¿ä½›åœ¨æé†’ä»€ä¹ˆã€‚</p>
        `;
      },
      choices: [
        {
          text: "A. â€œå¥½æ€ªï¼Œæ’ä¸Šçœ‹çœ‹æ˜¯ä»€ä¹ˆã€‚â€",
          hint: "ç›´æ¥æ’åˆ°æœºæˆ¿ç”µè„‘ä¸Š",
          next: "scene_usb_plug",
          effect: function (s) {
            s.reportedUsb = "plug";
            s.virusTriggered = true;
            setProgress(60);
          }
        },
        {
          text: "B. â€œå…ˆæ‹¿ç»™æ®·ç¼ºæ–¯æ±€è€å¸ˆã€‚â€",
          hint: "äº¤ç»™è€å¸ˆï¼Œç”¨å®‰å…¨ç¯å¢ƒåˆ†æ",
          next: "scene_usb_report",
          effect: function (s) {
            s.reportedUsb = "report";
            s.virusTriggered = false;
            s.trustYin += 8;
            setProgress(60);
          }
        },
        {
          text: "C. â€œç®—äº†ï¼Œå½“æ²¡çœ‹è§ã€‚â€",
          hint: "è½¬èº«ç¦»å¼€æœºæˆ¿",
          next: "scene_usb_ignore",
          effect: function (s) {
            s.reportedUsb = "ignore";
            setProgress(60);
          }
        }
      ],
      tip: "è¿™æ˜¯æœ¬ç« ç¬¬ä¸€æ¬¡çœŸæ­£å½±å“å‰§æƒ…èµ°å‘çš„é€‰æ‹©ï¼šä½ æ€ä¹ˆå¯¹å¾…è¿™ä¸ª U ç›˜ï¼Œä¼šå†³å®šæœºæˆ¿ä»Šæ™šå®‰ä¸å®‰å…¨ã€‚"
    },

    "scene_usb_plug": {
      id: "scene_usb_plug",
      speaker: "æ®·ç¼ºæ–¯æ±€",
      npcs: ["æ®·ç¼ºæ–¯æ±€"],
      bg: "img/bg_lab_evening.jpg",
      bgm: "tension",
      text: function () {
        addKnowledge("ransomware");
        return `
<p>ä½ æŠŠ U ç›˜æ’è¿›äº†ç¬¬ 12 å·æœºæˆ¿ç”µè„‘çš„ USB å£ã€‚</p>
<p>U ç›˜ä¸­æœ‰ä¸€ä¸ªåä¸ºâ€œ<span class="highlight">æœŸæœ«å¤ä¹ èµ„æ–™è¶…çº§ç‰ˆ.exe</span>â€çš„æ–‡ä»¶ï¼Œçœ‹ä¸Šå»éå¸¸è¯±äººã€‚</p>
<p>ä½ åˆšæƒ³åŒå‡»ï¼Œå±å¹•çªç„¶ä¸€é»‘ã€‚</p>
<p>å‡ ç§’é’Ÿåï¼Œä¸€ä¸ªè¡€çº¢è‰²çš„çª—å£å¼¹äº†å‡ºæ¥ï¼š</p>
<p style="border-left:3px solid #ff6f6f;padding-left:8px;margin:6px 0;">
â€œä½ çš„æ–‡ä»¶å·²ç»è¢«åŠ å¯†ã€‚<br>
è¯·åœ¨ 24 å°æ—¶å†…æ”¯ä»˜æŒ‡å®šé‡‘é¢çš„åŠ å¯†è´§å¸ï¼Œ<br>
å¦åˆ™æ‰€æœ‰æ•°æ®å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚â€
</p>
<p>ä½ èƒŒä¸Šä¸€å‡‰ï¼Œå†·æ±—é¡ºç€è„ŠèƒŒå¾€ä¸‹çˆ¬ã€‚</p>
<p class="npc">æ®·ç¼ºæ–¯æ±€ï¼š</p>
<p>â€œä½ åˆšæ‰â€¦â€¦æ˜¯ä¸æ˜¯æ’äº†ä¸€ä¸ªæ¥å†ä¸æ˜çš„ U ç›˜ï¼Ÿï¼â€</p>
        `;
      },
      choices: [
        {
          text: "è€è€å®å®æ‰¿è®¤ï¼šâ€œæ˜¯æˆ‘â€¦â€¦å¯¹ä¸èµ·ã€‚â€",
          hint: "å¦ç™½ä»å®½",
          next: "scene_usb_plug_follow",
          effect: function (s) {
            s.trustYin += 2;
          }
        },
        {
          text: "è¯•å›¾ç‹¡è¾©ï¼šâ€œå¯èƒ½æ˜¯ç”µè„‘è‡ªå·±åäº†ã€‚â€",
          hint: "å˜´ç¡¬ä»ä¸¥",
          next: "scene_usb_plug_follow",
          effect: function (s) {
            s.trustYin -= 3;
          }
        }
      ],
      tip: "å‹’ç´¢è½¯ä»¶ä¼šåŠ å¯†æ–‡ä»¶å†å‹’ç´¢èµé‡‘ï¼Œæœ€å¥½çš„é˜²å¾¡æ°¸è¿œæ˜¯ï¼šä¸è¦ç»™å®ƒæœºä¼šè¿›å»ã€‚"
    },

    "scene_usb_plug_follow": {
      id: "scene_usb_plug_follow",
      speaker: "æ®·ç¼ºæ–¯æ±€",
      npcs: ["æ®·ç¼ºæ–¯æ±€"],
      bg: "img/bg_lab_evening.jpg",
      bgm: "tension",
      text: function () {
        return `
<p>è¿˜æ²¡ç­‰ä½ è§£é‡Šå®Œï¼Œå…¶ä»–å‡ å°ç”µè„‘ä¹Ÿé™†ç»­å¼¹å‡ºäº†åŒæ ·çš„å‹’ç´¢ç•Œé¢ã€‚</p>
<p>æœºæˆ¿å±å¹•ä¸€å—ä¸€å—å˜é»‘ï¼Œä»¿ä½›å¤šç±³è¯ºéª¨ç‰Œå€’ä¸‹ã€‚</p>
<p class="npc">æ®·ç¼ºæ–¯æ±€ï¼š</p>
<p>â€œå…ˆåˆ«æ…Œâ€”â€”æˆ‘å…ˆæŠŠæœºæˆ¿å’Œæ ¡å›­ä¸»ç½‘éš”ç¦»ï¼Œå…å¾—ä¼ åˆ°åˆ«çš„åœ°æ–¹ï¼â€</p>
<p>ä»–ä¸‰ä¸¤ä¸‹æ“ä½œï¼Œæ–­å¼€äº†æœºæˆ¿äº¤æ¢æœºä¸ä¸»å¹²ç½‘çš„è¿æ¥ï¼Œåˆæ‹¿å‡ºæ‰‹æœºå¿«é€Ÿæ‹ä¸‹å‹’ç´¢ç•Œé¢çš„ä¿¡æ¯ã€‚</p>
<p>æ®·ç¼ºæ–¯æ±€å‹ä½å£°éŸ³ï¼š</p>
<p>â€œå‹’ç´¢è½¯ä»¶ã€‚åŠ å¯† + è¦é’±ã€‚å¥½æ¶ˆæ¯æ˜¯ï¼Œåªè¦å…¶ä»–åœ°æ–¹æœ‰å¤‡ä»½ï¼Œè¿˜ä¸è‡³äºä¸–ç•Œæœ«æ—¥ã€‚â€</p>
<p>ä»–å¹äº†å£æ°”ï¼š</p>
<p>â€œè¿™ä»¶äº‹å¿…é¡»æ±‡æŠ¥ç»™é‡‘åèŠ±è€å¸ˆå’Œåˆ˜æ ¡é•¿ã€‚ä½ å¾—è·Ÿæˆ‘ä¸€èµ·å»ã€‚â€</p>
        `;
      },
      choices: [
        {
          text: "è·Ÿç€æ®·ç¼ºæ–¯æ±€å»æ‰¾æ ¡é•¿ã€‚",
          hint: "å‰å¾€æ ¡é•¿åŠå…¬å®¤",
          next: "scene_principal_meeting",
          effect: function () {
            setProgress(75);
          }
        }
      ],
      tip: "æœºæˆ¿å·²ç»ä¸­æ‹›ï¼Œä½†ä½ è¿˜å¯ä»¥å¸®å¿™æŠŠæŸå¤±æ§åˆ¶åœ¨æœ€å°ã€‚æ¥ä¸‹æ¥æ˜¯ç­–ç•¥é—®é¢˜ã€‚"
    },

    "scene_usb_report": {
      id: "scene_usb_report",
      speaker: "æ®·ç¼ºæ–¯æ±€",
      npcs: ["æ®·ç¼ºæ–¯æ±€"],
      bg: "img/bg_lab_evening.jpg",
      bgm: "calm",
      text: function () {
        addKnowledge("sandbox");
        addKnowledge("ransomware");
        return `
<p>ä½ æŠŠ U ç›˜é€’ç»™æ®·ç¼ºæ–¯æ±€ã€‚</p>
<p class="npc">æ®·ç¼ºæ–¯æ±€ï¼š</p>
<p>â€œå†™â€˜åˆ«æ‰“å¼€â€™çš„ï¼Œè¦ä¹ˆæœ‰å¹½é»˜æ„Ÿï¼Œè¦ä¹ˆæœ‰æ¶æ„â€¦â€¦å¤§æ¦‚ç‡æ˜¯åè€…ã€‚â€</p>
<p>ä»–æ²¡æœ‰æ’åˆ°æœºæˆ¿ç”µè„‘ä¸Šï¼Œè€Œæ˜¯æ‹¿å‡ºè‡ªå·±çš„ç¬”è®°æœ¬ï¼Œæ‰“å¼€äº†ä¸€ä¸ªè™šæ‹Ÿæœºã€‚</p>
<p class="npc">æ®·ç¼ºæ–¯æ±€ï¼š</p>
<p>â€œåœ¨<span class="highlight">æ²™ç®±</span>é‡Œè·‘ä¸€è·‘ï¼Œçœ‹å®ƒæƒ³å¹²å˜›ã€‚â€</p>
<p>å‡ åˆ†é’Ÿåï¼Œè™šæ‹Ÿæœºå±å¹•è·³å‡ºäº†å‹’ç´¢ä¿¡æ¯ã€‚</p>
<p>â€œæœç„¶ï¼Œå‹’ç´¢è½¯ä»¶ã€‚å¥½åœ¨ä½ æ²¡ç›´æ¥æ’åˆ°æ•™å­¦æœºé‡Œï¼Œä»Šå¤©æœºæˆ¿æš‚æ—¶è¿˜å®‰å…¨ã€‚â€</p>
<p>ä»–æŠŠåˆ†æç»“æœæ‰“åŒ…ï¼Œå‡†å¤‡å‘ç»™é‡‘åèŠ±è€å¸ˆã€‚</p>
<p>â€œä¸è¿‡ï¼Œè¿™è¯´æ˜æœ‰äººå·²ç»å¼€å§‹åœ¨æ ¡å†…è¯•æ¢äº†ã€‚è¿™äº‹å¾—è·Ÿæ ¡é•¿æ±‡æŠ¥ã€‚â€</p>
        `;
      },
      choices: [
        {
          text: "å’Œæ®·ç¼ºæ–¯æ±€ä¸€èµ·å»æ‰¾æ ¡é•¿ã€‚",
          hint: "å‰å¾€æ ¡é•¿åŠå…¬å®¤",
          next: "scene_principal_meeting",
          effect: function () {
            setProgress(75);
          }
        }
      ],
      tip: "ä½ åˆšåˆšåšäº†ä¸€ä¸ªéå¸¸å…³é”®çš„æ­£ç¡®æ“ä½œï¼šä¸åœ¨ç”Ÿäº§ç¯å¢ƒæ’ä¸æ˜ U ç›˜ã€‚"
    },

    "scene_usb_ignore": {
      id: "scene_usb_ignore",
      speaker: null,
      npcs: ["çš‡å¤ªå­ï¼ˆçŒ«ï¼‰"],
      bg: "img/bg_lab_evening.jpg",
      bgm: "tension",
      text: function () {
        addKnowledge("ransomware");
        return `
<p>ä½ çœ‹äº†çœ‹ U ç›˜ï¼Œåˆçœ‹äº†çœ‹æ—¶é—´ã€‚</p>
<p>â€œç®—äº†ï¼Œä¸å…³æˆ‘çš„äº‹ã€‚â€ä½ è¿™æ ·æƒ³ç€ï¼ŒèƒŒèµ·ä¹¦åŒ…ç¦»å¼€æœºæˆ¿ã€‚</p>
<p>å¤œé‡Œï¼Œæ•™å­¦æ¥¼é‡Œç¯å…‰ç†„ç­ï¼Œåªå‰©ä¸‹èµ°å»Šå°½å¤´çš„å®‰å…¨å‡ºå£ç¯è¿˜äº®ç€ã€‚</p>
<p class="aside">æ®è¯´ï¼Œç”·å®¿ç®¡æ›¾é±¼å„¿å¤œå·¡æ—¶ï¼Œæ›¾çœ‹åˆ°æœºæˆ¿é‡Œæœ‰ä¸€å°ç”µè„‘çš„å±å¹•é—ªäº†ä¸€ä¸‹ã€‚</p>
<p>ç¬¬äºŒå¤©æ—©ä¸Šï¼Œä½ æ¥åˆ°å­¦æ ¡ï¼Œå‘ç°æœºæˆ¿é—¨ä¸Šè´´ç€ä¸€å¼ çº¸ï¼š</p>
<p style="text-align:center;margin-top:4px;margin-bottom:4px;"><span class="highlight">â€œæœºæˆ¿æš‚æ—¶å°é—­ç»´æŠ¤ï¼Œç¦æ­¢å…¥å†…ã€‚â€</span></p>
<p>å¾ˆå¿«ï¼Œç­ä¸»ä»»å‘Šè¯‰ä½ â€”â€”æ ¡é•¿è¦æ‰¾ä½ è°ˆä¸€è°ˆã€‚</p>
        `;
      },
      choices: [
        {
          text: "å‰å¾€æ ¡é•¿åŠå…¬å®¤ã€‚",
          hint: "äº‹æƒ…æ˜¾ç„¶é—¹å¤§äº†",
          next: "scene_principal_meeting",
          effect: function (s) {
            s.virusTriggered = true;
            setProgress(75);
          }
        }
      ],
      tip: "å¿½è§†é—®é¢˜ï¼Œæœ‰æ—¶å€™æ¯”åšé”™å†³å®šä»£ä»·æ›´å¤§ã€‚"
    },

    "scene_principal_meeting": {
      id: "scene_principal_meeting",
      speaker: "åˆ˜æ ¡é•¿",
      npcs: ["åˆ˜æ ¡é•¿", "æ®·ç¼ºæ–¯æ±€", "é‡‘åèŠ±è€å¸ˆ"],
      bg: "img/bg_office_night.jpg",
      bgm: "office",
      text: function (s) {
        let intro = "";
        if (s.reportedUsb === "plug") {
          intro = `
<p>ä½ å’Œæ®·ç¼ºæ–¯æ±€åŒ†åŒ†èµ¶åˆ°æ ¡é•¿åŠå…¬å®¤ã€‚</p>
<p>å±‹é‡Œå·²ç»åç€åˆ˜æ ¡é•¿å’Œé‡‘åèŠ±è€å¸ˆï¼Œæ¡Œä¸Šæ‘†ç€å‡ å¼ æ‰“å°å‡ºæ¥çš„å‹’ç´¢ç•Œé¢æˆªå›¾ã€‚</p>
          `;
        } else if (s.reportedUsb === "report") {
          intro = `
<p>ä½ å’Œæ®·ç¼ºæ–¯æ±€æ•²é—¨èµ°è¿›æ ¡é•¿åŠå…¬å®¤ã€‚</p>
<p>åˆ˜æ ¡é•¿çœ‹ç€æŠ¥å‘Šï¼Œçœ‰å¤´ç´§é”ï¼›é‡‘åèŠ±è€å¸ˆæ­£åœ¨ç¿»çœ‹é‚£åªå¯ç–‘ U ç›˜çš„åˆ†æè®°å½•ã€‚</p>
          `;
        } else {
          intro = `
<p>ä½ è¢«å«åˆ°äº†æ ¡é•¿åŠå…¬å®¤ã€‚</p>
<p>æ¡Œä¸Šæ‘†ç€å‡ å¼ æ‰“å°å‡ºæ¥çš„å‹’ç´¢ç•Œé¢æˆªå›¾ï¼Œè¿˜æœ‰ä¸€ä»½ã€Šæœºæˆ¿çªå‘äº‹ä»¶ç®€æŠ¥ã€‹ã€‚</p>
          `;
        }

        const virusDesc = s.virusTriggered
          ? `<p>é‡‘åèŠ±è€å¸ˆè§£é‡Šï¼šå‡ å°æœºæˆ¿ç”µè„‘å·²ç»è¢«å‹’ç´¢è½¯ä»¶åŠ å¯†ï¼Œå¥½åœ¨ç›®å‰åªå±€é™åœ¨æœºæˆ¿å±€åŸŸç½‘ã€‚</p>`
          : `<p>é‡‘åèŠ±è€å¸ˆè§£é‡Šï¼šç›®å‰åªæ˜¯å‘ç°äº†å‹’ç´¢è½¯ä»¶æ ·æœ¬ï¼Œå°šæœªåœ¨æœºæˆ¿å¤§é¢ç§¯çˆ†å‘ï¼Œä½†è¯´æ˜æ ¡å†…å·²ç»æœ‰äººåœ¨è¯•æ¢é˜²çº¿ã€‚</p>`;

        return `
${intro}
${virusDesc}
<p class="npc">åˆ˜æ ¡é•¿ï¼š</p>
<p>â€œæ€»ä¹‹ï¼Œä¸ç®¡æ˜¯å·²ç»ä¸­æ‹›ï¼Œè¿˜æ˜¯å·®ç‚¹ä¸­æ‹›ï¼Œè¿™éƒ½è¯´æ˜æˆ‘ä»¬çš„å®‰å…¨æ„è¯†æœ‰æ¼æ´ã€‚â€</p>
<p>ä»–æ•²äº†æ•²æ¡Œé¢ï¼š</p>
<p>â€œé—®é¢˜æ¥äº†â€”â€”æˆ‘ä»¬è¦ä¸è¦<span class="highlight">ç›´æ¥æŠŠå…¨æ ¡ç½‘ç»œéƒ½å…ˆæ–­æ‰</span>ä¸€æ®µæ—¶é—´ï¼Ÿâ€</p>
<p>æ®·ç¼ºæ–¯æ±€å’Œé‡‘åèŠ±å„è‡ªè¡¨äº†è§‚ç‚¹ï¼ŒåˆåŒæ—¶çœ‹å‘ä½ ã€‚</p>
<p class="npc">æ®·ç¼ºæ–¯æ±€ï¼š</p>
<p>â€œä½ ä¸€è·¯éƒ½åœ¨ç°åœºï¼Œæ¥è¯´è¯´ï¼Œä½ ä¼šæ€ä¹ˆé€‰ï¼Ÿâ€</p>
        `;
      },
      choices: [
        {
          text: "A. â€œå…ˆä¿æŠ¤å†è¯´ï¼Œç«‹åˆ»å°½é‡æ–­å¼€å¤–ç½‘ / éš”ç¦»ã€‚â€",
          hint: "æŸå¤±æœ€å°åŒ–ï¼Œä¿¡æ¯å°‘ä¸€ç‚¹",
          next: "scene_chapter1_end",
          effect: function (s) {
            s.chapter1EndChoice = "disconnect";
            addKnowledge("network_isolation");
            setProgress(100);
          }
        },
        {
          text: "B. â€œå…ˆåˆ«å…¨æ–­ï¼Œä¿æŒç½‘ç»œè¿è½¬ï¼Œä¸€è¾¹ç›‘æ§ä¸€è¾¹æŸ¥ã€‚â€",
          hint: "å†’é™©æ¢æƒ…æŠ¥",
          next: "scene_chapter1_end",
          effect: function (s) {
            s.chapter1EndChoice = "keep_online";
            addKnowledge("live_monitoring");
            setProgress(100);
          }
        }
      ],
      tip: "è¿™æ˜¯æœ¬ç« çš„å…³é”®æˆ˜ç•¥åˆ†æ­§ï¼Œä¼šç›´æ¥å†³å®šä½ åœ¨åç»­ç« èŠ‚èµ°â€œç¦»çº¿è°ƒæŸ¥çº¿â€è¿˜æ˜¯â€œåœ¨çº¿è¿½è¸ªçº¿â€ã€‚"
    },

 "scene_chapter1_end": {
 id: "scene_chapter1_end",
 endingKey: function (s) {
   return s.virusTriggered ? "bad_ransom" : "good";
 },
 speaker: "çš‡å¤ªå­ï¼ˆçŒ«ï¼‰",
 npcs: ["çš‡å¤ªå­ï¼ˆçŒ«ï¼‰"],
 bg: "img/bg_campus_evening.jpg",
 bgm: "office",
 text: function (s) {
    let strategyText = "";
    if (s.chapter1EndChoice === "disconnect") {
      strategyText = `
<p>æœ€ç»ˆæ–¹æ¡ˆï¼šåœ¨ä¿è¯å¿…è¦æ•™å­¦çš„å‰æä¸‹ï¼Œ<span class="highlight">å°½é‡éš”ç¦»</span>æ ¡å›­ç½‘ä¸å¤–ç½‘è¿æ¥ï¼Œä¼˜å…ˆä¿æŠ¤å·²æœ‰æ•°æ®ã€‚</p>
<p>è¿™æ„å‘³ç€åç»­çš„ä¸€æ®µæ—¶é—´é‡Œï¼Œå¾ˆå¤šè°ƒæŸ¥éƒ½è¦åœ¨ç›¸å¯¹â€œç¦»çº¿â€çš„ç¯å¢ƒä¸­è¿›è¡Œã€‚</p>
      `;
    } else if (s.chapter1EndChoice === "keep_online") {
      strategyText = `
<p>æœ€ç»ˆæ–¹æ¡ˆï¼šæ ¡ç½‘æš‚æ—¶ä¿æŒè¿è½¬ï¼Œç”± IT éƒ¨é—¨åŠ å¼º<span class="highlight">å®æ—¶ç›‘æ§</span>ï¼Œä¸€è¾¹é˜²å®ˆä¸€è¾¹æ”¶é›†æ”»å‡»è€…çš„çº¿ç´¢ã€‚</p>
<p>è¿™ä¹Ÿæ„å‘³ç€é£é™©ä¾æ—§å­˜åœ¨ï¼Œä½†ä½ ä»¬å°†æœ‰æ›´å¤šæœºä¼šçœ‹åˆ°æ”»å‡»çš„â€œçœŸé¢ç›®â€ã€‚</p>
      `;
    } else {
      strategyText = `<p>ï¼ˆç³»ç»Ÿï¼šå‡ºç°äº†ä¸€ä¸ªæœªé¢„æœŸçš„ç­–ç•¥ç»“æœï¼Œä¸è¿‡ä½ è‚¯å®šåšè¿‡é€‰æ‹©æ‰ä¼šçœ‹åˆ°è¿™é‡Œã€‚ï¼‰</p>`;
    }

    let usbSummary = "";
    if (s.reportedUsb === "plug") {
      usbSummary = `<p>ä½ æ›¾ç»ç›´æ¥æ’ä¸Šé‚£åªå¯ç–‘ U ç›˜ï¼Œäº²çœ¼è§è¯äº†å‹’ç´¢è½¯ä»¶çš„çˆ†å‘ã€‚</p>`;
    } else if (s.reportedUsb === "report") {
      usbSummary = `<p>ä½ æŠŠå¯ç–‘ U ç›˜äº¤ç»™äº†æ®·ç¼ºæ–¯æ±€ï¼Œç”¨æ²™ç®±åˆ†æï¼Œé¿å…äº†å½“åœºçˆ†å‘ã€‚</p>`;
    } else if (s.reportedUsb === "ignore") {
      usbSummary = `<p>ä½ æ›¾é€‰æ‹©å¯¹é‚£åª U ç›˜è§†è€Œä¸è§ï¼Œç¬¬äºŒå¤©é†’æ¥æ—¶ï¼Œæœºæˆ¿å·²ç»ä¸­æ‹›ã€‚</p>`;
    } else {
      usbSummary = `<p>å…³äºé‚£åª U ç›˜ï¼Œä½ ä¼¼ä¹åšå‡ºäº†ä¸€ä¸ªéå¸¸ç¥ç§˜çš„é€‰æ‹©â€¦â€¦</p>`;
    }

    return `
<p>ä¼šè®®ç»“æŸæ—¶ï¼Œçª—å¤–å·²ç»å®Œå…¨æš—äº†ä¸‹æ¥ã€‚</p>
${strategyText}
${usbSummary}
<p>èµ°å‡ºè¡Œæ”¿æ¥¼æ—¶ï¼Œä½ åœ¨æ¥¼ä¸‹çœ‹åˆ°çš‡å¤ªå­æ­£èººåœ¨è‰åœ°ä¸Šï¼Œæ‡’æ´‹æ´‹åœ°çœ‹ç€æ˜Ÿç©ºã€‚</p>
<p class="aside">çš‡å¤ªå­ï¼šå–µï½ï¼ˆå¤§æ¦‚çš„æ„æ€æ˜¯ï¼šâ€œä¸€æ ¹å°å°çš„ U ç›˜ï¼Œä¹Ÿèƒ½æ…åŠ¨ä¸€æ± æ˜¥æ°´ã€‚â€ï¼‰</p>
<p style="margin-top:10px;font-weight:600;">ã€ç¬¬ 1 ç«  Â· æœºæˆ¿çš„å¥‡æ€ªä¸€å¤œ Â· å®Œã€‘</p>
<p class="aside">ï¼ˆä½ å¯ä»¥ä»è¿™é‡Œè¿›å…¥ç¬¬ 2 ç« ï¼šå®¿èˆé‡Œçš„é™Œç”Ÿ Wi-Fiï¼Œæˆ–è€…å›åˆ°ç¬¬ 1 ç« é‡æ¥ä¸€æ¬¡ã€‚ï¼‰</p>
    `;
  },
  choices: [
    {
      text: "è¿›å…¥ç¬¬ 2 ç« ï¼šå®¿èˆé‡Œçš„é™Œç”Ÿ Wi-Fi",
      hint: "ä¿å­˜å½“å‰æˆå°±å¹¶å‰å¾€å®¿èˆçº¿",
      // next å®é™…ä¸ä¼šç”¨åˆ°ï¼Œå› ä¸ºä¼šç«‹åˆ»è·³è½¬é¡µé¢
      next: "scene_chapter1_end",
      effect: function (s) {
        // 1. å†™å…¥æœ¬åœ°å­˜æ¡£
        saveGameToLocal();
        // 2. è·³è½¬åˆ°ç¬¬äºŒç« é¡µé¢ï¼ˆæ–‡ä»¶åè¦å’Œä½ ä¿å­˜çš„ä¿æŒä¸€è‡´ï¼‰
        window.location.href = "chapter2.html";
      }
    },
    {
      text: "é‡æ–°ä½“éªŒæœ¬ç« ï¼Œå°è¯•ä¸åŒé€‰æ‹©",
      hint: "é‡ç½®çŠ¶æ€ï¼Œä»å¼€å¤´å†æ¥",
      next: "scene_title",
      effect: function (s) {
        s.role = null;
        s.trustYin = 0;
        s.trustJin = 0;
        s.virusTriggered = false;
        s.reportedUsb = null;
        s.chapter1EndChoice = null;
        s.knowledge = new Set();
        s.progress = 0;
        renderAchievementsPanel();
      }
    }
  ],
  tip: "ä½ å¯ä»¥ä»è¿™é‡Œè¿›å…¥ç¬¬äºŒç« ï¼›ä¹Ÿå¯ä»¥å›åˆ°ç¬¬ä¸€ç« ï¼Œå°è¯•ä¸åŒçš„ U ç›˜å¤„ç†æ–¹å¼å’Œç½‘ç»œç­–ç•¥ã€‚"
}

  };

  // ==== NPC Header ====
  function renderNpcHeader(speaker) {
    const container = document.getElementById("npc-header-container");
    container.innerHTML = "";
    if (!speaker) return;

    const profile = npcProfiles[speaker] || { role: "ç¥ç§˜ NPC", initial: "?", avatar: null };
    const wrapper = document.createElement("div");
    wrapper.className = "npc-dialogue-header";

    const avatar = document.createElement("div");
    avatar.className = "npc-avatar";
    if (profile.avatar) {
      const img = document.createElement("img");
      img.src = profile.avatar;
      img.alt = speaker;
      avatar.appendChild(img);
    } else {
      const span = document.createElement("span");
      span.textContent = profile.initial || "?";
      avatar.appendChild(span);
    }

    const info = document.createElement("div");
    info.className = "npc-info-main";
    const nameEl = document.createElement("div");
    nameEl.className = "npc-name";
    nameEl.textContent = speaker;
    const roleEl = document.createElement("div");
    roleEl.className = "npc-role";
    roleEl.textContent = profile.role || "";

    info.appendChild(nameEl);
    info.appendChild(roleEl);
    wrapper.appendChild(avatar);
    wrapper.appendChild(info);
    container.appendChild(wrapper);

    avatar.addEventListener("click", () => showNpcDetail(speaker));
    wrapper.title = "ç‚¹å‡»å¤´åƒæŸ¥çœ‹è§’è‰²è¯¦æƒ…";
  }

  // ==== é¡µæ˜¾ç¤º ====
 function showPage(scene, pageIndex) {
  const textContainer = document.getElementById("scene-text");
  const choiceContainer = document.getElementById("choice-list");

  currentPageIndex = pageIndex;

  const pageHtml = currentPages[pageIndex] || "";
  const sceneKey = scene.id + "_p" + pageIndex;

  choiceContainer.innerHTML = "";

  typeWriter(pageHtml, textContainer, sceneKey, () => {
    // è¿˜æœ‰åç»­é¡µï¼šæ˜¾ç¤ºâ€œç»§ç»­â€
    if (pageIndex < currentPages.length - 1) {
      const btn = document.createElement("button");
      btn.className = "choice-button";

      const labelSpan = document.createElement("span");
      labelSpan.className = "label";

      const hintSpan = document.createElement("span");
      hintSpan.className = "hint";
      hintSpan.textContent = "ä¸‹ä¸€é¡µ";

      btn.appendChild(labelSpan);
      btn.appendChild(hintSpan);
      choiceContainer.appendChild(btn);

      setTimeout(() => {
        if (currentSceneId !== scene.id) return;
        btn.classList.add("visible");
        // ç»™â€œç»§ç»­â€åŠ æ‰“å­—æœºæ•ˆæœï¼Œkey ç”¨å½“å‰ scene + é¡µå·
        typeChoiceLabel("ç»§ç»­", labelSpan, scene.id + "_page_next_" + pageIndex);
      }, 200);

      btn.addEventListener("click", () => {
        playSfx("choice");
        showPage(scene, pageIndex + 1);
      });

    } else {
      // æœ€åä¸€é¡µï¼šæ˜¾ç¤ºçœŸæ­£çš„é€‰é¡¹
      (scene.choices || []).forEach((choiceObj, index) => {
        const btn = document.createElement("button");
        btn.className = "choice-button";

        const labelSpan = document.createElement("span");
        labelSpan.className = "label";

        const hintSpan = document.createElement("span");
        hintSpan.className = "hint";
        hintSpan.textContent = choiceObj.hint || "";

        btn.appendChild(labelSpan);
        btn.appendChild(hintSpan);
        choiceContainer.appendChild(btn);

        btn.addEventListener("click", () => {
          playSfx("choice");
          if (typeof choiceObj.effect === "function") {
            choiceObj.effect(state);
          }
          updateStatusBar();
          renderScene(choiceObj.next);
        });

        const baseDelay = 220;
        setTimeout(() => {
          if (currentSceneId !== scene.id) return;
          btn.classList.add("visible");
          // æ¯ä¸ªé€‰é¡¹è‡ªå·±çš„æ‰“å­—æœº key
          typeChoiceLabel(
            choiceObj.text,
            labelSpan,
            scene.id + "_choice_" + index
          );
        }, baseDelay * index + 150);
      });
    }
  });
}


  // ==== åˆ·æ–°åœºæ™¯ ====
function renderScene(id) {
  const scene = scenes[id];
  if (!scene) {
    console.error("æœªçŸ¥åœºæ™¯:", id);
    return;
    }
    currentSceneId = id;

    const textContainer = document.getElementById("scene-text");
    const choiceContainer = document.getElementById("choice-list");
    textContainer.innerHTML = "";
    choiceContainer.innerHTML = "";

    // èƒŒæ™¯å›¾
    setBackgroundImage(scene.bg);

    // Header NPC
    renderNpcHeader(scene.speaker);

    // NPC åˆ—è¡¨ & æç¤º
  renderSidebarNpc(scene.npcs || []);
  setSidebarTip(scene.tip || "ä»”ç»†é˜…è¯»å¯¹è¯ä¸æè¿°ï¼Œå®ƒä»¬éƒ½åœ¨ç»™ä½ æç¤ºã€‚");
  updateStatusBar();
  const endingKey =
    typeof scene.endingKey === "function"
      ? scene.endingKey(state)
      : scene.endingKey;
  showEndingEffects(endingKey);

  // æ–° NPC ç™»åœº
  const npcSet = new Set();
    if (scene.speaker) npcSet.add(scene.speaker);
    (scene.npcs || []).forEach(n => npcSet.add(n));
    const newNpcNames = [];
    npcSet.forEach(name => {
      if (!seenNPCs.has(name)) {
        seenNPCs.add(name);
        newNpcNames.push(name);
      }
    });

    const rawText = typeof scene.text === "function"
      ? scene.text(state)
      : scene.text;

    currentPages = paginateText(rawText);
    currentPageIndex = 0;

    function startText() {
      showPage(scene, 0);
    }

    updateBgmForScene(scene);

    if (newNpcNames.length > 0) {
      showNpcIntroSequence(newNpcNames, startText);
    } else {
      startText();
    }
  }

  // ==== æˆå°± & èœå•æŒ‰é’® ====
  document.getElementById("btn-achievements").addEventListener("click", () => {
    const panel = document.getElementById("achievements-panel");
    if (!panel.classList.contains("active")) {
      renderAchievementsPanel();
    }
    panel.classList.add("active");
  });

  document.getElementById("btn-close-achievements").addEventListener("click", () => {
    document.getElementById("achievements-panel").classList.remove("active");
  });

  document.getElementById("achievements-panel").addEventListener("click", (e) => {
    if (e.target.id === "achievements-panel") {
      e.currentTarget.classList.remove("active");
    }
  });

  // NPC è¯¦æƒ…å…³é—­
  document.getElementById("npc-detail-overlay").addEventListener("click", (e) => {
    if (
      e.target.id === "npc-detail-overlay" ||
      e.target.classList.contains("npc-detail-close")
    ) {
      hideNpcDetail();
    }
  });

  const uiToggle = document.getElementById("ui-toggle");
  const uiPanel = document.getElementById("ui-panel");
  const btnCloseUi = document.getElementById("btn-close-ui");

  uiToggle.addEventListener("click", () => {
    uiPanel.classList.add("active");
  });
  btnCloseUi.addEventListener("click", () => {
    uiPanel.classList.remove("active");
  });
  uiPanel.addEventListener("click", (e) => {
    if (e.target.id === "ui-panel") {
      uiPanel.classList.remove("active");
    }
  });

  // ==== å¼€å§‹é¡µé¢é€»è¾‘ ====
  const startOverlay = document.getElementById("start-overlay");
  const btnStartGame = document.getElementById("btn-start-game");

  // å…ˆç»™èƒŒåå¡ç‰‡ä¸€ä¸ªé»˜è®¤èƒŒæ™¯ï¼Œä¸è‡³äºé»‘å±
  setBackgroundImage("img/bg_campus_evening.jpg");

  btnStartGame.addEventListener("click", () => {
    // å¼€å¯ BGM
    musicEnabled = true;
    musicLabel.textContent = "éŸ³ä¹ï¼šå¼€";
    musicIcon.textContent = "ğŸ”Š";

    startOverlay.classList.add("hidden");
    // æ¸²æŸ“ç¬¬ä¸€å¹•ï¼Œé‡Œé¢ä¼šæ ¹æ® scene.bgm è‡ªåŠ¨æ’­æ”¾å¯¹åº” BGM
    renderScene(currentSceneId);
  });

  // ä½ å¦‚æœæƒ³æ”¯æŒ â€œç‚¹å‡»ä»»æ„ç©ºç™½åŒºåŸŸä¹Ÿèƒ½è¿›å…¥â€ï¼Œå¯ä»¥åŠ ï¼š
  // startOverlay.addEventListener("click", (e) => {
  //   if (e.target.id === "start-overlay") btnStartGame.click();
  // });

</script>
</body>
</html>
